{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">{{ snippet.title }}</h2>

<div id="description-content" class="text-muted border-start border-3 border-secondary ps-3">
    {{ snippet.description or 'No description provided.' }}
</div>

{# Collapsible Thinking Steps Section #}
{% if snippet.thought_steps %}
<div class="mt-4">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 border-0 bg-transparent" type="button"
                    data-bs-toggle="collapse" data-bs-target="#thinkingStepsCollapse" aria-expanded="false"
                    aria-controls="thinkingStepsCollapse">
                    <i class="fas fa-brain me-2"></i>
                    <strong>AI Thinking Process</strong>
                    <i class="fas fa-chevron-down ms-2" id="thinkingStepsChevron"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="thinkingStepsCollapse">
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Multi-Step AI Analysis:</strong> These are the AI's reasoning steps that led to the final
                    code solution.
                </div>

                {% set steps = snippet.thought_steps %}

                {# Layer 1: Problem Decomposition & Strategy #}
                {% if steps.layer1 %}
                <div class="mb-4">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-architect me-2"></i>Layer 1: Problem Decomposition & Strategy (The
                                Architect)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="markdown-content">
                                <div class="p-3 border rounded bg-body-secondary">
                                    <div id="layer1-view-content">{{ steps.layer1 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Layer 2: Code Generation #}
                {% if steps.layer2 %}
                <div class="mb-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-code me-2"></i>Layer 2: Code Generation (The Coder)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="markdown-content">
                                <div class="p-3 border rounded bg-body-secondary">
                                    <div id="layer2-view-content">{{ steps.layer2 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Layer 3: Verification & Debugging #}
                {% if steps.layer3 %}
                <div class="mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0">
                                <i class="fas fa-vial me-2"></i>Layer 3: Verification & Debugging (The Tester)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="markdown-content">
                                <div class="p-3 border rounded bg-body-secondary">
                                    <div id="layer3-view-content">{{ steps.layer3 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Layer 4: Optimization & Final Review #}
                {% if steps.layer4 %}
                <div class="mb-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>Layer 4: Optimization & Final Review (The
                                Refiner)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="markdown-content">
                                <div class="p-3 border rounded bg-body-secondary">
                                    <div id="layer4-view-content">{{ steps.layer4 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card mt-4">
    <div class="card-header d-flex justify-content-end">
        <button class="btn btn-secondary btn-sm" id="copy-btn">
            <i class="bi bi-clipboard"></i> Copy
        </button>
    </div>
    <div class="card-body">
        {% set lang = (snippet.language or 'clike') %}
        {% if lang in ['mysql','postgresql','plsql','tsql','sqlite','mssql'] %}
        {% set prism_lang = 'sql' %}
        {% elif lang in ['pandas','numpy','scipy','sklearn','pytorch','tensorflow'] %}
        {% set prism_lang = 'python' %}
        {% else %}
        {% set prism_lang = lang %}
        {% endif %}
        <pre><code id="snippet-code" class="language-{{ prism_lang }}">{{ snippet.code }}</code></pre>
    </div>
</div>

<div class="mt-4 d-flex align-items-center gap-2">
    <button id="explain-btn" class="btn btn-info">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
            style="display: none;"></span>
        Explain
    </button>

    <!-- Edit Actions Dropdown -->
    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="editDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            Edit Actions
        </button>
        <ul class="dropdown-menu" aria-labelledby="editDropdown">
            <li><a class="dropdown-item" href="{{ url_for('main.edit_snippet', snippet_id=snippet.id) }}">
                    <i class="bi bi-pencil me-2"></i>Edit Snippet
                </a></li>
            <li><a class="dropdown-item" href="{{ url_for('main.move_snippet', snippet_id=snippet.id) }}">
                    <i class="bi bi-arrows-move me-2"></i>Move/Copy
                </a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="{{ url_for('main.snippet_history', snippet_id=snippet.id) }}">
                    <i class="bi bi-clock-history me-2"></i>View History
                </a></li>
            <li><a class="dropdown-item" href="{{ url_for('main.export_snippets') }}?snippet_id={{ snippet.id }}">
                    <i class="bi bi-download me-2"></i>Export Snippet
                </a></li>
        </ul>
    </div>

    <!-- Management Actions Dropdown -->
    <div class="dropdown">
        <button class="btn btn-warning dropdown-toggle" type="button" id="manageDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            Management
        </button>
        <ul class="dropdown-menu" aria-labelledby="manageDropdown">
            <li><a class="dropdown-item" href="{{ url_for('main.collections') }}">
                    <i class="bi bi-folder2-open me-2"></i>View Collections
                </a></li>
            <li><a class="dropdown-item" href="{{ url_for('main.notes') }}">
                    <i class="bi bi-journal-text me-2"></i>View Notes
                </a></li>
            <li><a class="dropdown-item" href="{{ url_for('main.snippet_actions') }}">
                    <i class="bi bi-gear me-2"></i>Snippet Actions
                </a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="{{ url_for('main.user_profile') }}">
                    <i class="bi bi-award me-2"></i>My Profile
                </a></li>
        </ul>
    </div>

    <!-- Delete Actions Dropdown -->
    <div class="dropdown">
        <button class="btn btn-danger dropdown-toggle" type="button" id="deleteDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            Delete Actions
        </button>
        <ul class="dropdown-menu" aria-labelledby="deleteDropdown">
            <li>
                <form action="{{ url_for('main.delete_snippet', snippet_id=snippet.id) }}" method="POST"
                    class="d-inline">
                    <button type="submit" class="dropdown-item text-danger"
                        onclick="return confirm('Are you sure you want to delete this snippet?');">
                        <i class="bi bi-trash me-2"></i>Delete Snippet
                    </button>
                </form>
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#" onclick="confirmDeleteAll()">
                    <i class="bi bi-x-circle me-2"></i>Delete All Snippets
                </a></li>
        </ul>
    </div>

    <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary ms-auto">Back to All Snippets</a>

    {% if prev_snippet_id %}
    <a class="btn btn-outline-secondary" id="prev-link"
        href="{{ url_for('main.view_snippet', snippet_id=prev_snippet_id) }}" title="Previous (Arrow Left)">
        <i class="bi bi-arrow-left"></i>
    </a>
    {% endif %}
    {% if next_snippet_id %}
    <a class="btn btn-outline-secondary" id="next-link"
        href="{{ url_for('main.view_snippet', snippet_id=next_snippet_id) }}" title="Next (Arrow Right)">
        <i class="bi bi-arrow-right"></i>
    </a>
    {% endif %}
</div>

<div id="explanation-container" class="mt-4 p-4 border rounded bg-body-secondary" style="display: none;">
    <div id="explanation-spinner" class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="explanation-content"></div>
    <div id="save-note-container" class="mt-3 d-flex gap-2 flex-wrap" style="display: none;">
        <a href="#" id="save-note-append-btn" class="btn btn-success btn-sm">Add to Description</a>
        <a href="#" id="save-note-replace-btn" class="btn btn-outline-warning btn-sm">Replace Description</a>
    </div>
</div>

<script>
    // --- Markdown rendering for description ---
    const renderDescription = () => {
        const descriptionContainer = document.getElementById('description-content');
        if (descriptionContainer) {
            // Check if the content is already rendered. If it contains HTML tags, assume it is.
            // This is a simple heuristic to avoid re-rendering already processed markdown.
            if (!descriptionContainer.innerHTML.includes('<p>') && !descriptionContainer.innerHTML.includes('<h')) {
                const rawMarkdown = descriptionContainer.textContent.trim();
                descriptionContainer.innerHTML = DOMPurify.sanitize(marked.parse(rawMarkdown));
            }
        }
    };

    // --- Render markdown content for thinking steps ---
    const renderThinkingStepsMarkdown = () => {
        const markdownContents = document.querySelectorAll('.markdown-content');
        markdownContents.forEach(container => {
            const content = container.querySelector('div');
            if (content && content.textContent.trim()) {
                try {
                    // Use marked library if available (loaded in base.html)
                    if (typeof marked !== 'undefined') {
                        const rawContent = content.textContent;
                        const rendered = marked.parse(rawContent);
                        content.innerHTML = DOMPurify.sanitize(rendered);

                        // Add syntax highlighting to code blocks
                        if (typeof Prism !== 'undefined') {
                            Prism.highlightAllUnder(content);
                        }

                        // Add copy buttons to code blocks
                        addCopyButtons(content);

                        // Render MathJax if available
                        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                            MathJax.typesetPromise([content]);
                        }

                        // Render Mermaid diagrams if available
                        renderMermaid(content);
                    }
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    // Fallback to plain text
                    content.textContent = content.textContent;
                }
            }
        });
    };

    // --- Add copy buttons to code blocks ---
    const addCopyButtons = (container) => {
        container.querySelectorAll('pre > code').forEach((codeEl) => {
            const pre = codeEl.parentElement;
            if (pre.style.position !== 'absolute') { // Don't add if already has copy button
                pre.style.position = 'relative';
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary';
                btn.textContent = 'Copy';
                btn.style.position = 'absolute';
                btn.style.top = '6px';
                btn.style.right = '6px';
                btn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(codeEl.innerText);
                        btn.textContent = 'Copied!';
                        setTimeout(() => btn.textContent = 'Copy', 1500);
                    } catch (_) { }
                });
                pre.appendChild(btn);
            }
        });
    };

    // --- Render Mermaid diagrams ---
    const renderMermaid = (container) => {
        if (typeof mermaid === 'undefined') return;

        const blocks = container.querySelectorAll('pre > code.language-mermaid, pre > code.lang-mermaid');
        blocks.forEach((code) => {
            const src = code.textContent;
            const div = document.createElement('div');
            div.className = 'mermaid';
            div.textContent = src;
            const pre = code.parentElement;
            pre.replaceWith(div);
        });

        try {
            mermaid.run({ querySelector: '.mermaid' });
        } catch (_) { }
    };

    // --- Toggle chevron icon ---
    const toggleChevron = () => {
        const chevron = document.getElementById('thinkingStepsChevron');
        const collapse = document.getElementById('thinkingStepsCollapse');
        if (chevron && collapse) {
            if (collapse.classList.contains('show')) {
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        renderDescription();
        renderThinkingStepsMarkdown();

        // Add event listener for collapse toggle
        const collapseElement = document.getElementById('thinkingStepsCollapse');
        if (collapseElement) {
            collapseElement.addEventListener('show.bs.collapse', toggleChevron);
            collapseElement.addEventListener('hide.bs.collapse', toggleChevron);
        }
    });

    document.addEventListener('pageshow', (event) => {
        // Only re-render if the page is retrieved from the bfcache
        if (event.persisted) {
            renderDescription();
            renderThinkingStepsMarkdown();
        }
    });

    // --- References to all our elements ---
    const snippetCode = document.getElementById('snippet-code');
    const copyBtn = document.getElementById('copy-btn');
    const explainBtn = document.getElementById('explain-btn');
    const explanationContainer = document.getElementById('explanation-container');
    const explanationContent = document.getElementById('explanation-content');
    const explanationSpinner = document.getElementById('explanation-spinner');
    const saveNoteContainer = document.getElementById('save-note-container');
    const saveNoteAppendBtn = document.getElementById('save-note-append-btn');
    const saveNoteReplaceBtn = document.getElementById('save-note-replace-btn');

    // --- Copy to Clipboard Logic ---
    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(snippetCode.textContent).then(() => {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            });
        });
    }

    // --- Explain Code Logic ---
    if (explainBtn) {
        explainBtn.addEventListener('click', async () => {
            setLoadingState(explainBtn, true, 'Explaining...'); // Set loading state
            saveNoteContainer.style.display = 'none';
            explanationContainer.style.display = 'block';
            explanationContent.innerHTML = '';
            explanationSpinner.style.display = 'block';

            // Start AI animation
            if (window.startAiAnimation) {
                window.startAiAnimation();
            }

            try {
                const response = await fetch("{{ url_for('main.explain') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: snippetCode.textContent })
                });
                const data = await response.json();
                if (data.explanation) {
                    explanationContent.innerHTML = DOMPurify.sanitize(marked.parse(data.explanation));
                    saveNoteContainer.style.display = 'block';
                } else {
                    explanationContent.innerHTML = '<p class="text-danger">Failed to get explanation.</p>';
                }
            } catch (error) {
                console.error('Error fetching explanation:', error);
                explanationContent.innerHTML = '<p class="text-danger">An error occurred. Please try again.</p>';
            } finally {
                setLoadingState(explainBtn, false); // Revert loading state
                explanationSpinner.style.display = 'none';
                // Stop AI animation
                if (window.stopAiAnimation) {
                    window.stopAiAnimation();
                }
            }
        });
    }

    // --- Save as Note Logic ---
    const persistAndGoToEdit = (mode) => {
        const explanationHTML = explanationContent.innerHTML;
        try {
            localStorage.setItem('explanation_transfer', JSON.stringify({ mode, html: explanationHTML }));
        } catch (e) {
            // Fallback for older logic if storage fails
            if (mode === 'append') {
                localStorage.setItem('add_to_description', explanationHTML);
            } else if (mode === 'replace') {
                localStorage.setItem('replace_description', explanationHTML);
            }
        }
        window.location.href = "{{ url_for('main.edit_snippet', snippet_id=snippet.id) }}";
    };

    if (saveNoteAppendBtn) {
        saveNoteAppendBtn.addEventListener('click', (e) => {
            e.preventDefault();
            persistAndGoToEdit('append');
        });
    }
    if (saveNoteReplaceBtn) {
        saveNoteReplaceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            persistAndGoToEdit('replace');
        });
    }

    // --- Keyboard navigation (Left/Right arrows) ---
    const prevUrl = `{% if prev_snippet_id %}{{ url_for('main.view_snippet', snippet_id=prev_snippet_id) }}{% endif %}`;
    const nextUrl = `{% if next_snippet_id %}{{ url_for('main.view_snippet', snippet_id=next_snippet_id) }}{% endif %}`;
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && prevUrl) {
            window.location.href = prevUrl;
        } else if (e.key === 'ArrowRight' && nextUrl) {
            window.location.href = nextUrl;
        }
    });

    // Prefetch adjacent pages into the HTTP cache for faster nav
    (async () => {
        try {
            if (prevUrl) fetch(prevUrl, { method: 'GET', credentials: 'same-origin', cache: 'force-cache' });
            if (nextUrl) fetch(nextUrl, { method: 'GET', credentials: 'same-origin', cache: 'force-cache' });
        } catch (_) { }
    })();

    // --- Touch swipe navigation ---
    let touchStartX = null;
    let touchStartY = null;
    let touchStartTime = 0;
    const SWIPE_THRESHOLD = 60; // px
    const SWIPE_TIME = 500; // ms

    const onTouchStart = (e) => {
        const touch = e.changedTouches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchStartTime = Date.now();
    };

    const onTouchEnd = (e) => {
        if (touchStartX === null) return;
        const dt = Date.now() - touchStartTime;
        const touch = e.changedTouches[0];
        const dx = touch.clientX - touchStartX;
        const dy = touch.clientY - touchStartY;
        // Horizontal swipe with minimal vertical movement
        if (dt <= SWIPE_TIME && Math.abs(dx) >= SWIPE_THRESHOLD && Math.abs(dy) < 80) {
            if (dx < 0 && nextUrl) {
                // swipe left -> next
                window.location.href = nextUrl;
            } else if (dx > 0 && prevUrl) {
                // swipe right -> prev
                window.location.href = prevUrl;
            }
        }
        touchStartX = touchStartY = null;
    };

    document.addEventListener('touchstart', onTouchStart, { passive: true });
    document.addEventListener('touchend', onTouchEnd, { passive: true });
</script>

<style>
    .markdown-content {
        line-height: 1.6;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        color: var(--bs-body-color);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .markdown-content p {
        color: var(--bs-body-color);
        margin-bottom: 1rem;
    }

    .markdown-content ul,
    .markdown-content ol {
        color: var(--bs-body-color);
        margin-bottom: 1rem;
    }

    .markdown-content li {
        color: var(--bs-body-color);
    }

    .markdown-content blockquote {
        border-left: 4px solid var(--bs-primary);
        padding-left: 1rem;
        margin: 1rem 0;
        color: var(--bs-body-color);
        background-color: var(--bs-secondary-bg);
        padding: 1rem;
        border-radius: 0.25rem;
    }

    .markdown-content code {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.9em;
    }

    .markdown-content pre {
        background-color: var(--bs-dark);
        color: var(--bs-light);
    }

    .markdown-content pre code {
        background-color: transparent;
        color: inherit;
        padding: 0;
    }

    .markdown-content table {
        color: var(--bs-body-color);
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1rem;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid var(--bs-border-color);
        padding: 0.5rem;
        text-align: left;
    }

    .markdown-content th {
        background-color: var(--bs-secondary-bg);
        font-weight: bold;
    }

    .markdown-content a {
        color: var(--bs-link-color);
    }

    .markdown-content a:hover {
        color: var(--bs-link-hover-color);
    }

    /* Dark theme specific adjustments */
    :root[data-bs-theme='dark'] .markdown-content pre {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }

    :root[data-bs-theme='dark'] .markdown-content code {
        background-color: #2a2a2a;
        color: #e0e0e0;
    }

    /* Light theme specific adjustments */
    :root[data-bs-theme='light'] .markdown-content pre {
        background-color: #f8f9fa;
        color: #495057;
    }

    :root[data-bs-theme='light'] .markdown-content code {
        background-color: #f1f3f4;
        color: #495057;
    }
</style>
{% endblock %}