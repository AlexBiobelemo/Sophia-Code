{% extends "base.html" %}

{% block content %}
    {# Prefetch adjacent snippet pages to speed up navigation #}
    {% if prev_snippet_id %}
        <link rel="prefetch" href="{{ url_for('main.view_snippet', snippet_id=prev_snippet_id) }}" as="document">
    {% endif %}
    {% if next_snippet_id %}
        <link rel="prefetch" href="{{ url_for('main.view_snippet', snippet_id=next_snippet_id) }}" as="document">
    {% endif %}

    <h2 class="mb-3">{{ snippet.title }}</h2>

    <div id="description-content" class="text-muted border-start border-3 border-secondary ps-3">
        {{ snippet.description or 'No description provided.' }}
    </div>

    <div class="card bg-dark mt-4">
        <div class="card-header d-flex justify-content-end">
            <button class="btn btn-secondary btn-sm" id="copy-btn">
                <i class="bi bi-clipboard"></i> Copy
            </button>
        </div>
        <div class="card-body">
            {% set lang = (snippet.language or 'clike') %}
            {% if lang in ['mysql','postgresql','plsql','tsql','sqlite','mssql'] %}
                {% set prism_lang = 'sql' %}
            {% elif lang in ['pandas','numpy','scipy','sklearn','pytorch','tensorflow'] %}
                {% set prism_lang = 'python' %}
            {% else %}
                {% set prism_lang = lang %}
            {% endif %}
            <pre><code id="snippet-code" class="language-{{ prism_lang }}">{{ snippet.code }}</code></pre>
        </div>
    </div>

    <div class="mt-4 d-flex align-items-center gap-2">
        <button id="explain-btn" class="btn btn-info">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
            Explain
        </button>
        <a href="{{ url_for('main.edit_snippet', snippet_id=snippet.id) }}" class="btn btn-secondary">Edit</a>
        <a href="{{ url_for('main.move_snippet', snippet_id=snippet.id) }}" class="btn btn-secondary">Move/Copy</a>
        <form action="{{ url_for('main.delete_snippet', snippet_id=snippet.id) }}" method="POST" class="d-inline">
            <input type="submit" value="Delete" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this snippet?');">
        </form>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary ms-auto">Back to All Snippets</a>
        <a href="{{ url_for('main.snippet_history', snippet_id=snippet.id) }}" class="btn btn-outline-warning">History</a>
        {% if prev_snippet_id %}
            <a class="btn btn-outline-secondary" id="prev-link" href="{{ url_for('main.view_snippet', snippet_id=prev_snippet_id) }}" title="Previous (Arrow Left)">
                <i class="bi bi-arrow-left"></i>
            </a>
        {% endif %}
        {% if next_snippet_id %}
            <a class="btn btn-outline-secondary" id="next-link" href="{{ url_for('main.view_snippet', snippet_id=next_snippet_id) }}" title="Next (Arrow Right)">
                <i class="bi bi-arrow-right"></i>
            </a>
        {% endif %}
    </div>

    <div id="explanation-container" class="mt-4 p-4 border rounded bg-body-secondary" style="display: none;">
        <div id="explanation-spinner" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="explanation-content"></div>
        <div id="save-note-container" class="mt-3 d-flex gap-2 flex-wrap" style="display: none;">
             <a href="#" id="save-note-append-btn" class="btn btn-success btn-sm">Add to Description</a>
             <a href="#" id="save-note-replace-btn" class="btn btn-outline-warning btn-sm">Replace Description</a>
        </div>
    </div>

<script>
    // --- Markdown rendering for description ---
    const renderDescription = () => {
        const descriptionContainer = document.getElementById('description-content');
        if (descriptionContainer) {
            // Check if the content is already rendered. If it contains HTML tags, assume it is.
            // This is a simple heuristic to avoid re-rendering already processed markdown.
            if (!descriptionContainer.innerHTML.includes('<p>') && !descriptionContainer.innerHTML.includes('<h')) {
                const rawMarkdown = descriptionContainer.textContent.trim();
                descriptionContainer.innerHTML = DOMPurify.sanitize(marked.parse(rawMarkdown));
            }
        }
    };

    document.addEventListener('DOMContentLoaded', renderDescription);
    document.addEventListener('pageshow', (event) => {
        // Only re-render if the page is retrieved from the bfcache
        if (event.persisted) {
            renderDescription();
        }
    });

    // --- References to all our elements ---
    const snippetCode = document.getElementById('snippet-code');
    const copyBtn = document.getElementById('copy-btn');
    const explainBtn = document.getElementById('explain-btn');
    const explanationContainer = document.getElementById('explanation-container');
    const explanationContent = document.getElementById('explanation-content');
    const explanationSpinner = document.getElementById('explanation-spinner');
    const saveNoteContainer = document.getElementById('save-note-container');
    const saveNoteAppendBtn = document.getElementById('save-note-append-btn');
    const saveNoteReplaceBtn = document.getElementById('save-note-replace-btn');

    // --- Copy to Clipboard Logic ---
    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(snippetCode.textContent).then(() => {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            });
        });
    }

    // --- Explain Code Logic ---
    if (explainBtn) {
        explainBtn.addEventListener('click', async () => {
            setLoadingState(explainBtn, true, 'Explaining...'); // Set loading state
            saveNoteContainer.style.display = 'none';
            explanationContainer.style.display = 'block';
            explanationContent.innerHTML = '';
            explanationSpinner.style.display = 'block';

            // Start AI animation
            if (window.startAiAnimation) {
                window.startAiAnimation();
            }

            try {
                const response = await fetch("{{ url_for('main.explain') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: snippetCode.textContent })
                });
                const data = await response.json();
                if (data.explanation) {
                    explanationContent.innerHTML = DOMPurify.sanitize(marked.parse(data.explanation));
                    saveNoteContainer.style.display = 'block';
                } else {
                    explanationContent.innerHTML = '<p class="text-danger">Failed to get explanation.</p>';
                }
            } catch (error) {
                console.error('Error fetching explanation:', error);
                explanationContent.innerHTML = '<p class="text-danger">An error occurred. Please try again.</p>';
            } finally {
                setLoadingState(explainBtn, false); // Revert loading state
                explanationSpinner.style.display = 'none';
                // Stop AI animation
                if (window.stopAiAnimation) {
                    window.stopAiAnimation();
                }
            }
        });
    }

    // --- Save as Note Logic ---
    const persistAndGoToEdit = (mode) => {
        const explanationHTML = explanationContent.innerHTML;
        try {
            localStorage.setItem('explanation_transfer', JSON.stringify({ mode, html: explanationHTML }));
        } catch (e) {
            // Fallback for older logic if storage fails
            if (mode === 'append') {
                localStorage.setItem('add_to_description', explanationHTML);
            } else if (mode === 'replace') {
                localStorage.setItem('replace_description', explanationHTML);
            }
        }
        window.location.href = "{{ url_for('main.edit_snippet', snippet_id=snippet.id) }}";
    };

    if (saveNoteAppendBtn) {
        saveNoteAppendBtn.addEventListener('click', (e) => {
            e.preventDefault();
            persistAndGoToEdit('append');
        });
    }
    if (saveNoteReplaceBtn) {
        saveNoteReplaceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            persistAndGoToEdit('replace');
        });
    }

    // --- Keyboard navigation (Left/Right arrows) ---
    const prevUrl = `{% if prev_snippet_id %}{{ url_for('main.view_snippet', snippet_id=prev_snippet_id) }}{% endif %}`;
    const nextUrl = `{% if next_snippet_id %}{{ url_for('main.view_snippet', snippet_id=next_snippet_id) }}{% endif %}`;
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && prevUrl) {
            window.location.href = prevUrl;
        } else if (e.key === 'ArrowRight' && nextUrl) {
            window.location.href = nextUrl;
        }
    });

    // Prefetch adjacent pages into the HTTP cache for faster nav
    (async () => {
        try {
            if (prevUrl) fetch(prevUrl, { method: 'GET', credentials: 'same-origin', cache: 'force-cache' });
            if (nextUrl) fetch(nextUrl, { method: 'GET', credentials: 'same-origin', cache: 'force-cache' });
        } catch (_) {}
    })();

    // --- Touch swipe navigation ---
    let touchStartX = null;
    let touchStartY = null;
    let touchStartTime = 0;
    const SWIPE_THRESHOLD = 60; // px
    const SWIPE_TIME = 500; // ms

    const onTouchStart = (e) => {
        const touch = e.changedTouches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchStartTime = Date.now();
    };

    const onTouchEnd = (e) => {
        if (touchStartX === null) return;
        const dt = Date.now() - touchStartTime;
        const touch = e.changedTouches[0];
        const dx = touch.clientX - touchStartX;
        const dy = touch.clientY - touchStartY;
        // Horizontal swipe with minimal vertical movement
        if (dt <= SWIPE_TIME && Math.abs(dx) >= SWIPE_THRESHOLD && Math.abs(dy) < 80) {
            if (dx < 0 && nextUrl) {
                // swipe left -> next
                window.location.href = nextUrl;
            } else if (dx > 0 && prevUrl) {
                // swipe right -> prev
                window.location.href = prevUrl;
            }
        }
        touchStartX = touchStartY = null;
    };

    document.addEventListener('touchstart', onTouchStart, { passive: true });
    document.addEventListener('touchend', onTouchEnd, { passive: true });
</script>
{% endblock %}
