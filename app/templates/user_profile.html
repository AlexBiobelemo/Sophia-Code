{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar-compact.css') }}">
{% endblock %}

{% block content %}
<h2 class="mb-4">My Profile</h2>

<div class="card mb-4">
    <div class="card-header">
        <h3>{{ current_user.username }}</h3>
    </div>
    <div class="card-body">
        <p><strong>Email:</strong> {{ current_user.email }}</p>
        <p><strong>Total Points:</strong> <span class="badge bg-info">{{ total_points }}</span></p>
    </div>
</div>

<h3 class="mb-3">My Badges</h3>
{% if user_badges %}
<div class="row">
    {% for user_badge in user_badges %}
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                {% if user_badge.badge.image_url %}
                {% if user_badge.badge.image_url.startswith('bi-') %}
                <i class="bi {{ user_badge.badge.image_url }} fs-1 text-warning"></i>
                {% else %}
                <img src="{{ user_badge.badge.image_url }}" alt="{{ user_badge.badge.name }}" class="img-fluid mb-2"
                    style="max-height: 80px;">
                {% endif %}
                {% else %}
                <i class="bi bi-award fs-1 text-warning"></i>
                {% endif %}
                <h5 class="card-title mt-2">{{ user_badge.badge.name }}</h5>
                <p class="card-text text-muted">{{ user_badge.badge.description }}</p>
                <small class="text-muted">Earned on: {{ user_badge.timestamp.strftime('%Y-%m-%d') }}</small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-muted">You haven't earned any badges yet. Keep contributing to earn some!</p>
{% endif %}

<h3 class="mb-3 mt-4">My Statistics</h3>
<div class="row mb-4">
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Total Snippets</small>
                <p class="card-text fs-5 mb-0">{{ total_snippets }}</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Total Collections</small>
                <p class="card-text fs-5 mb-0">{{ total_collections }}</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Avg Snippet Length</small>
                <p class="card-text fs-5 mb-0">{{ average_snippet_length }}</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Total Tokens</small>
                <p class="card-text fs-5 mb-0">{{ total_tokens }}</p>
            </div>
        </div>
    </div>
</div>

<h3 class="mb-3 mt-4">Additional Statistics</h3>
<div class="row mb-4">
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Code Quality</small>
                <p class="card-text fs-5 mb-0">{{ code_quality_score or 'N/A' }}</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Current Streak</small>
                <p class="card-text fs-5 mb-0">{{ current_streak or '0' }} days</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Total Views</small>
                <p class="card-text fs-5 mb-0">{{ total_views or '0' }}</p>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">Favorite Time</small>
                <p class="card-text fs-5 mb-0">{{ favorite_coding_time or 'Unknown' }}</p>
            </div>
        </div>
    </div>
</div>

<h4 class="mb-3">Top Tags Usage</h4>
{% if top_tags %}
<div class="row mb-4">
    {% for tag in top_tags %}
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card text-center h-100">
            <div class="card-body p-2">
                <small class="card-title text-muted">{{ tag.name }}</small>
                <p class="card-text fs-5 mb-0">{{ tag.count }}</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-muted">No tags data available yet.</p>
{% endif %}

<h4 class="mb-3">Snippet Language Distribution</h4>
{% if language_stats %}
<div class="marquee-container">
    <div class="marquee-content" id="language-charts-container">
        {% for stat in language_stats %}
        <div class="marquee-item">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">{{ stat.language }}</h5>
                    <canvas id="chart-{{ stat.language | lower | replace(' ', '-') }}" width="100"
                        height="100"></canvas>
                    <p class="card-text mt-2">{{ stat.count }} snippets</p>
                </div>
            </div>
        </div>
        {% endfor %}
        {% for stat in language_stats %}
        <div class="marquee-item">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">{{ stat.language }}</h5>
                    <canvas id="chart-{{ stat.language | lower | replace(' ', '-') }}-clone" width="100"
                        height="100"></canvas>
                    <p class="card-text mt-2">{{ stat.count }} snippets</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<p class="text-muted">No snippets available to display language distribution.</p>
{% endif %}

<h4 class="mb-3">Activity Calendar</h4>
<div class="card mb-4">
    <div class="card-body">
        <div class="activity-calendar-container">
            <div class="calendar-header">
                <div class="calendar-navigation">
                    <button class="btn btn-sm btn-outline-secondary" id="prev-month" title="Previous Month">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <h5 class="calendar-title mb-0" id="calendar-title">December 2025</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="next-month" title="Next Month">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-legend">
                    <span class="legend-label">Less</span>
                    <div class="legend-squares">
                        <div class="legend-square level-0"></div>
                        <div class="legend-square level-1"></div>
                        <div class="legend-square level-2"></div>
                        <div class="legend-square level-3"></div>
                        <div class="legend-square level-4"></div>
                    </div>
                    <span class="legend-label">More</span>
                </div>
            </div>
            <div class="calendar-grid" id="activity-calendar">
                <!-- Calendar will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<h4 class="mb-3 mt-4">Monthly Activity</h4>
<div class="card mb-4">
    <div class="card-body">
        <canvas id="activity-barchart" height="100"></canvas>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Back to Home</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    // Define the custom Chart.js plugin globally
    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function (chart, args, options) {
            const width = chart.width,
                height = chart.height,
                ctx = chart.ctx;
            ctx.restore();
            ctx.fillStyle = 'white';
            const fontSize = (height / 114).toFixed(2);
            ctx.font = `${fontSize}em sans-serif`;
            ctx.textBaseline = "middle";
            const text = `${options.percentage}%`;
            const textX = Math.round((width - ctx.measureText(text).width) / 2);
            const textY = height / 2;
            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    };

    // Activity calendar functions
    let currentCalendarDate = new Date();
    let activityData = {};

    function generateActivityCalendar(activityData, targetDate) {
        const calendarContainer = document.getElementById('activity-calendar');
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth();

        // Update calendar title
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('calendar-title').textContent = `${monthNames[month]} ${year}`;

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        // Build calendar HTML
        let html = '<div class="calendar-weekdays">';
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Add day headers
        dayNames.forEach(day => {
            html += `<div class="calendar-weekday">${day}</div>`;
        });
        html += '</div>';

        html += '<div class="calendar-days">';

        // Add empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dateObj = new Date(year, month, day);
            const count = activityData[dateString] || 0;
            const level = getActivityLevel(count);
            const isToday = targetDate.toDateString() === new Date().toDateString() && day === new Date().getDate();

            html += `<div class="calendar-day level-${level} ${isToday ? 'today' : ''}" 
                           data-date="${dateString}" 
                           title="${dateString}: ${count} snippet${count !== 1 ? 's' : ''}">
                        <span class="day-number">${day}</span>
                        <span class="activity-count">${count > 0 ? count : ''}</span>
                    </div>`;
        }

        html += '</div>';
        calendarContainer.innerHTML = html;
    }

    function getActivityLevel(count) {
        if (count === 0) return 0;
        if (count === 1) return 1;
        if (count <= 3) return 2;
        if (count <= 6) return 3;
        return 4;
    }

    // Navigation functions
    function navigateMonth(direction) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
        generateActivityCalendar(activityData, currentCalendarDate);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const languageStatsElement = document.getElementById('language-stats-data');
        const languageStats = languageStatsElement ? JSON.parse(languageStatsElement.dataset.stats.replace(/'/g, '"')) : [];

        const backgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#E7E9ED', '#8AC926', '#F4A261', '#2A9D8F', '#E9C46A', '#A8DADC'
        ];
        const hoverBackgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#E7E9ED', '#8AC926', '#F4A261', '#2A9D8F', '#E9C46A', '#A8DADC'
        ];

        languageStats.forEach((stat, index) => {
            const chartIdBase = `chart-${stat.language.toLowerCase().replace(' ', '-')}`;
            const originalCtx = document.getElementById(chartIdBase).getContext('2d');
            const cloneCtx = document.getElementById(`${chartIdBase}-clone`).getContext('2d');
            const total = languageStats.reduce((sum, s) => sum + s.count, 0);
            const percentage = (stat.count / total * 100).toFixed(1);

            const chartConfig = {
                type: 'doughnut',
                data: {
                    labels: [stat.language, 'Other'],
                    datasets: [{
                        data: [stat.count, total - stat.count],
                        backgroundColor: [
                            backgroundColors[index % backgroundColors.length],
                            '#e0e0e0' // Grey for 'Other'
                        ],
                        hoverBackgroundColor: [
                            hoverBackgroundColors[index % hoverBackgroundColors.length],
                            '#c0c0c0'
                        ],
                        borderWidth: 1
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Make it a donut chart
                    plugins: {
                        legend: {
                            display: false // Hide legend as we'll show percentage in text
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    if (label === stat.language) {
                                        return `${label}: ${stat.count} (${percentage}%)`;
                                    }
                                    return ''; // Hide tooltip for 'Other' segment
                                }
                            }
                        },
                        centerText: { // Pass options to the plugin
                            percentage: percentage
                        }
                    },
                    elements: {
                        arc: {
                            borderWidth: 0
                        }
                    }
                },
                plugins: [centerTextPlugin] // Use the globally defined plugin
            };

            new Chart(originalCtx, chartConfig);
            new Chart(cloneCtx, chartConfig);
        });

        // Load activity data and create calendar
        fetch('/api/user_activity')
            .then(response => response.json())
            .then(data => {
                // Convert activity data to daily format
                activityData = {};

                // Build daily activity map
                data.forEach(item => {
                    activityData[item.date] = item.count;
                });

                // Generate initial calendar
                generateActivityCalendar(activityData, currentCalendarDate);

                // Create monthly bar chart from the same daily data
                const monthlyData = {};
                data.forEach(item => {
                    const month = item.date.substring(0, 7); // Extract YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = 0;
                    }
                    monthlyData[month] += item.count;
                });

                // Sort months chronologically
                const sortedMonths = Object.keys(monthlyData).sort();
                const monthlyCounts = sortedMonths.map(m => monthlyData[m]);

                // Create monthly bar chart
                const activityChartCtx = document.getElementById('activity-barchart').getContext('2d');
                new Chart(activityChartCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'Snippets per Month',
                            data: monthlyCounts,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading activity data:', error);
            });

        // Add navigation event listeners
        document.getElementById('prev-month').addEventListener('click', () => navigateMonth(-1));
        document.getElementById('next-month').addEventListener('click', () => navigateMonth(1));

        // Initialize Bootstrap collapse components
        var collapseElements = document.querySelectorAll('.collapse');
        collapseElements.forEach(function (el) {
            new bootstrap.Collapse(el, {
                toggle: false
            });
        });
    });
</script>
{% endblock %}