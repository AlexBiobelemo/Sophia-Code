<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }} - Dev Command Center</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¡</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Premium very-dark theme overrides -->
    <style>
      :root[data-bs-theme='dark']{
        /* Core surfaces (blacker tones) */
        --bs-body-bg: #070b10;               /* page background */
        --bs-body-color: #d6d9de;
        --bs-tertiary-bg: #090d12;           /* subtle surfaces */
        --bs-secondary-bg: #0b1118;          /* cards, inputs, bg-body-secondary */
        --bs-card-bg: #0c1219;               /* cards */
        --bs-border-color: #1a2430;
        --bs-border-color-translucent: rgba(26,36,48,.6);

        /* Brand palette (darker, high-contrast) */
        --bs-primary: #1e5bb8;   /* deep blue */
        --bs-secondary: #6c757d;
        --bs-success: #198754;
        --bs-info: #2a829f;      /* teal-ish */
        --bs-warning: #b58600;   /* muted amber */
        --bs-danger: #a23a3a;    /* deep red */
        --bs-light: #1b232d;
        --bs-dark: #0b1118;

        /* Links */
        --bs-link-color: #59a3ff;
        --bs-link-hover-color: #8abfff;
      }

      body { background-color: var(--bs-body-bg); color: var(--bs-body-color); }
      .bg-dark { background-color: var(--bs-dark) !important; }
      .card { background-color: var(--bs-card-bg); border-color: var(--bs-border-color); }
      .modal-content, .dropdown-menu, .toast, .offcanvas { background-color: var(--bs-card-bg); border-color: var(--bs-border-color); }
      .bg-body-secondary { background-color: var(--bs-secondary-bg) !important; }
      .bg-body-tertiary { background-color: var(--bs-body-bg) !important; }
      .list-group-item { background-color: var(--bs-card-bg); color: var(--bs-body-color); border-color: var(--bs-border-color); }
      .form-control, .form-select, .form-control:focus, .form-select:focus {
        background-color: var(--bs-secondary-bg); color: var(--bs-body-color);
        border-color: var(--bs-border-color);
      }
      .btn-primary { background-color: var(--bs-primary); border-color: var(--bs-primary); }
      .btn-outline-primary { color: var(--bs-primary); border-color: var(--bs-primary); }
      .btn-outline-primary:hover { background-color: rgba(30,91,184,.15); }
      .btn-danger { background-color: var(--bs-danger); border-color: var(--bs-danger); }
      .btn-outline-danger { color: var(--bs-danger); border-color: var(--bs-danger); }
      .btn-outline-danger:hover { background-color: rgba(162,58,58,.15); }
      .btn-warning { background-color: var(--bs-warning); border-color: var(--bs-warning); color: #1a1a1a; }
      .btn-outline-warning { color: var(--bs-warning); border-color: var(--bs-warning); }
      .navbar, .dropdown-menu { border-color: var(--bs-border-color); }
      .border-body { border-color: var(--bs-border-color) !important; }
    </style>
</head>
<body class="bg-body-tertiary">
    <div id="particles-js"></div>
    <div class="toast-container position-fixed top-0 end-0 p-3"> </div>
    <nav class="navbar navbar-expand-lg bg-dark border-bottom border-body" data-bs-theme="dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">Sophia</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <form id="global-search-form" class="d-flex w-50" action="{{ url_for('main.search') }}" method="get">
                <input id="navbar-search" class="form-control me-2" type="search" name="q" placeholder="Search snippets/solutions (supports tag:, lang:, in:, before:, after:)" aria-label="Search">
                <select id="search-scope" class="form-select me-2 w-auto">
                    <option value="snippets">Snippets</option>
                    <option value="solutions">Solutions</option>
                    <option value="both">Both</option>
                </select>
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
            <div class="collapse navbar-collapse" id="navbarNav">
               <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item me-2">
                    <button class="btn btn-link nav-link p-0" id="theme-toggle" aria-label="Toggle theme">
                        <i id="theme-icon" class="bi"></i>
                    </button>
                </li>
                {% if current_user.is_anonymous %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.login') }}">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.register') }}">Register</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.collections') }}"><i class="bi bi-folder2-open me-1"></i>My Solutions</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.create_snippet') }}"><i class="bi bi-plus-circle me-1"></i>New Snippet</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.generate') }}"><i class="bi bi-magic me-1"></i>AI Generate</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.chat') }}"><i class="bi bi-chat-dots me-1"></i>Chat</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-journal-code me-1"></i>LeetCode
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('main.add_problem') }}"><i class="bi bi-plus-circle me-2"></i>Add Problem</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.search_solutions') }}"><i class="bi bi-search me-2"></i>Search Solutions</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        {% if current_user.is_authenticated and current_user.avatar_filename %}
                          <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar_filename) }}?v={{ range(1,999999)|random }}" class="rounded-circle me-2" width="24" height="24" alt="avatar">
                        {% else %}
                          <i class="bi bi-person-circle me-2"></i>
                        {% endif %}
                        <span>{{ current_user.username }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('main.user_profile') }}"><i class="bi bi-award me-2"></i>My Profile</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.edit_profile') }}"><i class="bi bi-gear me-2"></i>Account Settings</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.export_snippets') }}"><i class="bi bi-box-arrow-down me-2"></i>Export Snippets</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </li>
                {% endif %}
            </ul>

            </div>
        </div>
    </nav>
    <main class="container mt-4 main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-messages" style="display: none;">
                    {% for category, message in messages %}
                        <div class="flash" data-category="{{ category }}" data-message="{{ message }}"></div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div id="page-content">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Sophia Bottom-Right Widget -->
    <style>
      /* Floating Action Button (FAB) */
      #sophiaFab {
        position: fixed; right: 16px; bottom: 16px; z-index: 10001;
        display: inline-flex; align-items: center; gap: 8px;
        transform-origin: bottom right; transition: transform .18s ease, box-shadow .18s ease, padding .2s ease, width .2s ease;
        overflow: hidden; white-space: nowrap; padding-right: 12px;
      }
      #sophiaFab .label { max-width: 0; opacity: 0; transition: max-width .2s ease, opacity .2s ease; display: inline-block; }
      #sophiaFab:hover { transform: translateZ(0) scale(1.06); }
      #sophiaFab:hover .label { max-width: 200px; opacity: 1; }
      #sophiaFab.glow { box-shadow: 0 0 0.9rem rgba(255,193,7,.95), 0 0 1.6rem rgba(255,193,7,.45); }

      /* Dock (fixed position, not draggable/resizable) */
      #sophiaDock {
        position: fixed; right: 16px; bottom: 84px; width: 420px; max-width: min(540px, calc(100% - 32px));
        height: min(520px, 70vh); z-index: 10000; display: none; user-select: none;
      }
      #sophiaDock.card { display: flex; flex-direction: column; }
      #sophiaDock .card-header { user-select: none; }
      #sophiaDock .card-body { flex: 1 1 auto; overflow: auto; user-select: text; }
      #sophiaDock .card-footer { user-select: none; }
      /* Smaller font and distinct bubbles (user only) */
      #sophiaDock .bubble { font-size: 0.9rem; border: 1px solid var(--bs-border-color); }
      #sophiaDock .bubble pre, #sophiaDock .bubble code { font-size: 0.85rem; }
      /* User bubble uses primary tint for subtle emphasis */
      #sophiaDock .msg-user .bubble { background-color: rgba(30,91,184,.15); border-color: rgba(30,91,184,.45); }
      /* Assistant remains neutral (no bubble) */
    </style>

    <button id="sophiaFab" type="button" class="btn btn-warning rounded-pill">
      <i class="bi bi-chat-dots fs-5"></i>
      <span class="label">Ask Sophia</span>
    </button>

    <div id="sophiaDock" class="card shadow-lg" hidden aria-hidden="true">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Sophia Assistant</strong>
        <div class="d-flex gap-2">
          <button id="sophiaClear" type="button" class="btn btn-sm btn-outline-danger">Clear</button>
          <button id="sophiaClose" type="button" class="btn btn-sm btn-outline-secondary">Close</button>
        </div>
      </div>
      <div class="card-body">
        <div id="sophia-log"></div>
      </div>
      <div class="card-footer d-flex gap-2 align-items-center">
        <input id="sophia-input" class="form-control" placeholder="Ask a question..." />
        <button id="sophia-send" class="btn btn-primary">Send</button>
        <button id="sophia-stop" class="btn btn-outline-warning">Stop</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax for inline math in chat and pages -->
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <!-- Mermaid for diagram code blocks -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>try{ mermaid.initialize({ startOnLoad: false, theme: document.documentElement.getAttribute('data-bs-theme')==='dark'?'dark':'default' }); }catch(_){};</script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Bottom-right widget elements
            const sophiaLog = document.getElementById('sophia-log');
            const sophiaInput = document.getElementById('sophia-input');
            const sophiaSend = document.getElementById('sophia-send');
            const sophiaStop = document.getElementById('sophia-stop');
            const sophiaDock = document.getElementById('sophiaDock');
            const sophiaFab = document.getElementById('sophiaFab');
            const sophiaClose = document.getElementById('sophiaClose');
            const sophiaClear = document.getElementById('sophiaClear');
            let inlineSessionId = null;
            let inlineAbort = null;
            let lastSelectionText = '';

            function addCopyButtons(container){
              container.querySelectorAll('pre > code').forEach((codeEl)=>{
                const pre = codeEl.parentElement;
                pre.style.position = 'relative';
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary';
                btn.textContent = 'Copy';
                btn.style.position = 'absolute';
                btn.style.top = '6px';
                btn.style.right = '6px';
                btn.addEventListener('click', async ()=>{
                  try { await navigator.clipboard.writeText(codeEl.innerText); btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent='Copy',1500);} catch(_){}
                });
                pre.appendChild(btn);
              });
            }
            async function renderMermaid(container){
              if (!window.mermaid) return;
              const blocks = container.querySelectorAll('pre > code.language-mermaid, pre > code.lang-mermaid');
              for (const code of blocks){
                const src = code.textContent;
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = src;
                const pre = code.parentElement;
                pre.replaceWith(div);
              }
              try { await mermaid.run({ querySelector: '.mermaid' }); } catch(_){ }
            }
            function appendChat(role, content){
              const wrap = document.createElement('div');
              wrap.className = 'mb-3 ' + (role==='assistant' ? 'msg-assistant' : 'msg-user');
              if (role === 'assistant'){
                const rendered = DOMPurify.sanitize(marked.parse(content || ''));
                wrap.innerHTML = `<div class=\"fw-bold\">Sophia</div><div class=\"p-2\">${rendered}</div>`;
                sophiaLog.appendChild(wrap);
                if (window.Prism) { try { Prism.highlightAllUnder(wrap); } catch(_){} }
                addCopyButtons(wrap);
                if (window.MathJax && window.MathJax.typesetPromise) { try { MathJax.typesetPromise([wrap]); } catch(_){} }
                renderMermaid(wrap);
              } else {
                wrap.innerHTML = `<div class=\"fw-bold\">You</div><div class=\"bubble border rounded p-2\">${DOMPurify.sanitize(content)}</div>`;
                sophiaLog.appendChild(wrap);
              }
              sophiaLog.scrollTop = sophiaLog.scrollHeight;
            }
            async function ensureInlineSession(){
              if (inlineSessionId) return inlineSessionId;
              try {
                const cached = localStorage.getItem('inline_chat_session_id');
                if (cached) { inlineSessionId = Number(cached); return inlineSessionId; }
                const res = await fetch("{{ url_for('main.api_chat_new') }}", { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title: 'Quick Chat' })});
                const data = await res.json();
                inlineSessionId = data.session_id;
                localStorage.setItem('inline_chat_session_id', String(inlineSessionId));
                return inlineSessionId;
              } catch(_) { return null; }
            }
            async function sendInline(msg){
              appendChat('user', msg);
              // streaming container
              const wrap = document.createElement('div');
              wrap.className = 'mb-3 msg-assistant';
              wrap.innerHTML = `<div class=\"fw-bold\">Sophia</div><div class=\"p-2\"><div class=\"d-flex align-items-center gap-2 mb-2\"><div class=\"spinner-border spinner-border-sm\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div><span>Thinking...</span></div><div class=\"stream-out\"></div></div>`;
              const out = wrap.querySelector('.stream-out');
              sophiaLog.appendChild(wrap);
              sophiaLog.scrollTop = sophiaLog.scrollHeight;
              try {
                const sid = await ensureInlineSession();
                inlineAbort = new AbortController();
                const res = await fetch("{{ url_for('main.api_chat_stream') }}", { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ session_id: sid, message: msg }), signal: inlineAbort.signal });
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buf = '';
                let lastRender = 0;
                const spinner = wrap.querySelector('.spinner-border');
                const label = wrap.querySelector('.d-flex span');
                while (true){
                  const {done, value} = await reader.read();
                  if (done) break;
                  const chunk = decoder.decode(value, {stream:true});
                  buf += chunk;
                  const now = performance.now();
                  if (now - lastRender > 120){
                    if (spinner) spinner.style.display='none'; if (label) label.textContent='';
                    out.innerHTML = DOMPurify.sanitize(marked.parse(buf));
                    lastRender = now;
                    sophiaLog.scrollTop = sophiaLog.scrollHeight;
                  }
                }
                // final render
                out.innerHTML = DOMPurify.sanitize(marked.parse(buf));
                if (window.Prism) { try { Prism.highlightAllUnder(wrap); } catch(_){} }
                addCopyButtons(wrap);
                if (window.MathJax && window.MathJax.typesetPromise) { try { MathJax.typesetPromise([wrap]); } catch(_){} }
                renderMermaid(wrap);
              } catch(e){
                const err = document.createElement('div'); err.className='text-danger'; err.textContent='Network error'; out.replaceWith(err);
              }
            }
            if (sophiaSend) sophiaSend.addEventListener('click', ()=>{ const v = sophiaInput.value.trim(); if (!v) return; sophiaInput.value=''; sendInline(v); });
            if (sophiaInput) sophiaInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); const v = sophiaInput.value.trim(); if (!v) return; sophiaInput.value=''; sendInline(v);} });
            if (sophiaStop) sophiaStop.addEventListener('click', ()=>{ if (inlineAbort) { try { inlineAbort.abort(); } catch(_){} } });

            async function loadInlineHistory(){
              try {
                const sid = await ensureInlineSession();
                if (!sid) return;
                const res = await fetch(`{{ url_for('main.api_chat_session', session_id=0) }}`.replace('0', String(sid)));
                const msgs = await res.json();
                sophiaLog.innerHTML = '';
                msgs.forEach(m => appendChat(m.role, m.content));
              } catch(_){ }
            }

            function isOpen(){ return sophiaDock && !sophiaDock.hidden; }
            function openDock(){ if (!sophiaDock) return; sophiaDock.hidden = false; sophiaDock.setAttribute('aria-hidden','false'); }
            function closeDock(){ if (!sophiaDock) return; sophiaDock.hidden = true; sophiaDock.setAttribute('aria-hidden','true'); }
            function toggleDock(){ if (!sophiaDock) return; if (isOpen()) closeDock(); else openDock(); }
            if (sophiaClose) sophiaClose.addEventListener('click', toggleDock);
            if (sophiaFab) sophiaFab.addEventListener('click', async ()=>{
              const opening = !isOpen();
              toggleDock();
              if (opening) {
                await loadInlineHistory();
              }
              if (isOpen()){
                sophiaInput && sophiaInput.focus();
                if (lastSelectionText && lastSelectionText.length){ const ask = lastSelectionText.slice(0, 4000); lastSelectionText=''; sophiaFab.classList.remove('glow'); await sendInline(ask); }
              }
            });

            // Clear chat: delete current inline session and reset
            if (sophiaClear) sophiaClear.addEventListener('click', async ()=>{
              try {
                const sid = await ensureInlineSession();
                if (sid) {
                  await fetch(`{{ url_for('main.api_chat_delete', session_id=0) }}`.replace('0', String(sid)), { method:'POST' });
                }
              } catch(_){ }
              inlineSessionId = null;
              try { localStorage.removeItem('inline_chat_session_id'); } catch(_){ }
              if (sophiaLog) sophiaLog.innerHTML = '';
            });

            // Track current selection across the page
            function updateSelection(){
              const sel = window.getSelection();
              const text = sel ? sel.toString().trim() : '';
              if (text && text.length>1){ lastSelectionText = text; if (sophiaFab) sophiaFab.classList.add('glow'); }
              else { lastSelectionText=''; if (sophiaFab) sophiaFab.classList.remove('glow'); }
            }
            document.addEventListener('selectionchange', updateSelection);
            document.addEventListener('mouseup', updateSelection);

            // Expose for programmatic open
            window.openSophiaWith = async function(text){
              openDock();
              if (text){ sophiaInput.value = text; await sendInline(text); }
            };
            const toastContainer = document.querySelector('.toast-container');
            // Scope-aware search routing
            const form = document.getElementById('global-search-form');
            const scopeSel = document.getElementById('search-scope');
            if (form && scopeSel) {
                form.addEventListener('submit', (e) => {
                    const scope = scopeSel.value;
                    if (scope === 'solutions') {
                        form.action = "{{ url_for('main.search_solutions') }}";
                    } else if (scope === 'both') {
                        form.action = "{{ url_for('main.search_combined') }}";
                    } else {
                        form.action = "{{ url_for('main.search') }}";
                    }
                });
            }
            const flashMessages = document.querySelectorAll('.flash');

            flashMessages.forEach(flash => {
                const message = flash.dataset.message;
                const category = flash.dataset.category;

                // Map flash categories to Bootstrap background colors
                const bgClass = {
                    'success': 'bg-success',
                    'danger': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[category] || 'bg-secondary';

                // Create the toast HTML
                const toastHTML = `
                    <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                // Add the toast to the container and show it
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const newToastEl = toastContainer.lastElementChild;
                const newToast = new bootstrap.Toast(newToastEl, { delay: 5000 });
                newToast.show();
            });
        });
    </script>
    <script src="https://unpkg.com/prettier@2.8.4/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-babel.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-postcss.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-markdown.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-typescript.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-yaml.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-php.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-ruby.js"></script>
    <script>
        (() => {
            'use strict';
            const getStoredTheme = () => localStorage.getItem('theme');
            const setStoredTheme = theme => localStorage.setItem('theme', theme);
            const getPreferredTheme = () => {
                const storedTheme = getStoredTheme();
                if (storedTheme) return storedTheme;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            };
            const setTheme = theme => {
                document.documentElement.setAttribute('data-bs-theme', theme);
            };
            setTheme(getPreferredTheme());

            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');

            const updateIcon = (theme) => {
                if (themeIcon) { // Check if themeIcon exists
                    if (theme === 'dark') {
                        themeIcon.classList.remove('bi-sun-fill');
                        themeIcon.classList.add('bi-moon-stars-fill');
                    } else {
                        themeIcon.classList.remove('bi-moon-stars-fill');
                        themeIcon.classList.add('bi-sun-fill');
                    }
                }
            };
            updateIcon(getPreferredTheme());

            if (themeToggleBtn) { // Check if themeToggleBtn exists
                themeToggleBtn.addEventListener('click', () => {
                    const currentTheme = getStoredTheme() || getPreferredTheme();
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    setStoredTheme(newTheme);
                    setTheme(newTheme);
                    updateIcon(newTheme);
                });
            }
        })();
    </script>

    <script>
        
        // The FAB glows to indicate selection is available; clicking it asks Sophia with the selection.
    </script>

    <script>
        // Keyboard shortcuts (Shift + key to avoid browser Ctrl/Cmd conflicts)
        // Shift + S  -> focus navbar search
        // Shift + F  -> jump to filters
        // Shift + N  -> new snippet
        // Shift + J / K -> scroll between cards
        document.addEventListener('keydown', (e) => {
            if (!e.shiftKey || e.ctrlKey || e.metaKey || e.altKey) return;
            const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
            const isTyping = tag === 'input' || tag === 'textarea' || tag === 'select' || (e.target && e.target.isContentEditable);
            const key = e.key.toLowerCase();
            if (key === 's') {
                const input = document.getElementById('navbar-search');
                if (input) { e.preventDefault(); input.focus(); }
            } else if (key === 'f') {
                const el = document.getElementById('filters-bar');
                if (el) { e.preventDefault(); el.scrollIntoView({ behavior: 'smooth' }); }
            } else if (key === 'n') {
                e.preventDefault();
                window.location.href = "{{ url_for('main.create_snippet') }}";
            } else if (key === 'j' || key === 'k') {
                e.preventDefault();
                const cards = Array.from(document.querySelectorAll('.card'));
                if (!cards.length) return;
                const direction = key === 'j' ? 1 : -1;
                const currentIndex = cards.findIndex(c => c.getBoundingClientRect().top > 10);
                let target = null;
                if (direction > 0) {
                    target = cards[Math.max(currentIndex, 0)];
                } else {
                    const prevIdx = (currentIndex <= 0 ? 0 : currentIndex - 1);
                    target = cards[prevIdx];
                }
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const headers = document.querySelectorAll('h1, h2');
            headers.forEach(header => {
                const text = header.textContent;
                let newText = '';
                for (let i = 0; i < text.length; i++) {
                    newText += `<span class="char">${text[i]}</span>`;
                }
                header.innerHTML = newText;

                const chars = header.querySelectorAll('.char');
                chars.forEach((char, i) => {
                    setTimeout(() => {
                        char.style.opacity = 1;
                    }, i * 50);
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Default particlesJS configuration (snow animation)
        const defaultParticlesConfig = {
            "particles": {
                "number": {
                    "value": 80, // Default number of particles
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#ffffff" // Default white color
                },
                "shape": {
                    "type": "star", // Using star shape as seen in view_snippet.html
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 5
                    }
                },
                "opacity": {
                    "value": 0.5,
                    "random": true, // Random opacity for a softer look
                    "anim": {
                        "enable": true, // Enable animation for opacity
                        "speed": 1,
                        "opacity_min": 0.1,
                        "sync": false
                    }
                },
                "size": {
                    "value": 3,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 0.1,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": false
                },
                "move": {
                    "enable": true,
                    "speed": 2,
                    "direction": "bottom",
                    "random": false,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": false
                    },
                    "onclick": {
                        "enable": false
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 400,
                        "line_linked": {
                            "opacity": 1
                        }
                    },
                    "bubble": {
                        "distance": 400,
                        "size": 40,
                        "duration": 2,
                        "opacity": 8,
                        "speed": 3
                    },
                    "repulse": {
                        "distance": 200,
                        "duration": 0.4
                    },
                    "push": {
                        "particles_nb": 4
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        };

        // Glowing AI generation animation configuration
        const aiParticlesConfig = {
            "particles": {
                "number": {
                    "value": 200, // More elements
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    // Dynamic glow with blue, green, purple
                    "value": ["#00BFFF", "#32CD32", "#8A2BE2", "#ADD8E6", "#90EE90", "#DA70D6"], // Brighter shades for glow
                },
                "shape": {
                    "type": "star",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 5
                    }
                },
                "opacity": {
                    "value": 0.8, // Higher opacity for glowing effect
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 2, // Faster animation for glow
                        "opacity_min": 0.3,
                        "sync": false
                    }
                },
                "size": {
                    "value": 5, // Larger size for glow
                    "random": true,
                    "anim": {
                        "enable": true, // Enable size animation for pulsating glow
                        "speed": 10,
                        "size_min": 1,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": false
                },
                "move": {
                    "enable": true,
                    "speed": 3, // Slightly faster movement
                    "direction": "none", // More dynamic movement for glow
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": false
                    },
                    "onclick": {
                        "enable": false
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 400,
                        "line_linked": {
                            "opacity": 1
                        }
                    },
                    "bubble": {
                        "distance": 400,
                        "size": 40,
                        "duration": 2,
                        "opacity": 8,
                        "speed": 3
                    },
                    "repulse": {
                        "distance": 200,
                        "duration": 0.4
                    },
                    "push": {
                        "particles_nb": 4
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        };

        // Global function to start AI animation
        window.startAiAnimation = () => {
            particlesJS('particles-js', aiParticlesConfig);
        };

        // Global function to stop AI animation
        window.stopAiAnimation = () => {
            particlesJS('particles-js', defaultParticlesConfig);
        };

        // Global function to set loading state for a button
        window.setLoadingState = (button, isLoading, loadingText = 'Loading...', spinner = true) => {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalHtml = button.innerHTML; // Store original HTML
                button.innerHTML = `
                    ${spinner ? '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' : ''}
                    ${loadingText}
                `;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalHtml || ''; // Restore original HTML
                delete button.dataset.originalHtml; // Clean up
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize particlesJS with default config on page load
            particlesJS('particles-js', defaultParticlesConfig);
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pageContent = document.getElementById('page-content');

            // Fade in on page load
            pageContent.classList.add('fade-in');

            // Fade out on link click
            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', e => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('/')) {
                        e.preventDefault();
                        pageContent.classList.remove('fade-in');
                        pageContent.classList.add('fade-out');
                        setTimeout(() => {
                            window.location.href = href;
                        }, 500);
                    }
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('navbar-search');
            if (searchInput) {
                const placeholders = [
                    "Python snippets",
                    "Flask solutions",
                    "Javascript examples",
                    "CSS animations"
                ];
                let currentPlaceholder = 0;
                let currentChar = 0;
                let isDeleting = false;

                function type() {
                    const placeholder = placeholders[currentPlaceholder];
                    let displayText;

                    if (isDeleting) {
                        displayText = placeholder.substring(0, currentChar--);
                    } else {
                        displayText = placeholder.substring(0, currentChar++);
                    }

                    searchInput.setAttribute('placeholder', displayText);

                    if (!isDeleting && currentChar === placeholder.length) {
                        isDeleting = true;
                        setTimeout(type, 1500);
                    } else if (isDeleting && currentChar === 0) {
                        isDeleting = false;
                        currentPlaceholder = (currentPlaceholder + 1) % placeholders.length;
                        setTimeout(type, 300);
                    } else {
                        setTimeout(type, isDeleting ? 50 : 100);
                    }
                }
                type();
            }
        });
    </script>
</body>
</html>
