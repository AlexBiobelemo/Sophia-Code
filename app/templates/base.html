<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }} - Dev Command Center</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¡</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/button-glass.css') }}">

    <!-- Premium very-dark theme overrides -->
    <style>
        :root[data-bs-theme='dark'] {
            /* Core surfaces (blacker tones) */
            --bs-body-bg: #070b10;
            /* page background */
            --bs-body-color: #d6d9de;
            --bs-tertiary-bg: #090d12;
            /* subtle surfaces */
            --bs-secondary-bg: #0b1118;
            /* cards, inputs, bg-body-secondary */
            --bs-card-bg: #0c1219;
            /* cards */
            --bs-border-color: #1a2430;
            --bs-border-color-translucent: rgba(26, 36, 48, .6);

            /* Brand palette (darker, high-contrast) */
            --bs-primary: #1e5bb8;
            /* deep blue */
            --bs-secondary: #6c757d;
            --bs-success: #198754;
            --bs-info: #2a829f;
            /* teal-ish */
            --bs-warning: #b58600;
            /* muted amber */
            --bs-danger: #a23a3a;
            /* deep red */
            --bs-light: #1b232d;
            --bs-dark: #0b1118;

            /* Links */
            --bs-link-color: #59a3ff;
            --bs-link-hover-color: #8abfff;
        }

        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }

        .bg-dark {
            background-color: var(--bs-dark) !important;
        }

        .card {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
        }

        .modal-content,
        .dropdown-menu,
        .toast,
        .offcanvas {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
        }

        .bg-body-secondary {
            background-color: var(--bs-secondary-bg) !important;
        }

        .bg-body-tertiary {
            background-color: var(--bs-body-bg) !important;
        }

        .list-group-item {
            background-color: var(--bs-card-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        .form-control,
        .form-select,
        .form-control:focus,
        .form-select:focus {
            background-color: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .btn-outline-primary {
            color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .btn-outline-primary:hover {
            background-color: rgba(30, 91, 184, .15);
        }

        .btn-danger {
            background-color: var(--bs-danger);
            border-color: var(--bs-danger);
        }

        .btn-outline-danger {
            color: var(--bs-danger);
            border-color: var(--bs-danger);
        }

        .btn-outline-danger:hover {
            background-color: rgba(162, 58, 58, .15);
        }

        .btn-warning {
            background-color: var(--bs-warning);
            border-color: var(--bs-warning);
            color: #1a1a1a;
        }

        .btn-outline-warning {
            color: var(--bs-warning);
            border-color: var(--bs-warning);
        }

        .btn-outline-warning:hover {
            background-color: rgba(255, 193, 7, .15);
        }

        .navbar,
        .dropdown-menu {
            border-color: var(--bs-border-color);
        }

        .border-body {
            border-color: var(--bs-border-color) !important;
        }
    </style>

    <!-- Light theme overrides -->
    <style>
        :root[data-bs-theme='light'] {
            /* Core surfaces (light tones) */
            --bs-body-bg: #ffffff;
            /* page background */
            --bs-body-color: #212529;
            --bs-tertiary-bg: #f8f9fa;
            /* subtle surfaces */
            --bs-secondary-bg: #f1f3f4;
            /* cards, inputs, bg-body-secondary */
            --bs-card-bg: #ffffff;
            /* cards */
            --bs-border-color: #dee2e6;
            --bs-border-color-translucent: rgba(222, 226, 230, .6);

            /* Brand palette (maintained for consistency) */
            --bs-primary: #0d6efd;
            /* blue */
            --bs-secondary: #6c757d;
            --bs-success: #198754;
            --bs-info: #0dcaf0;
            /* cyan */
            --bs-warning: #ffc107;
            /* amber */
            --bs-danger: #dc3545;
            /* red */
            --bs-light: #f8f9fa;
            --bs-dark: #212529;

            /* Links */
            --bs-link-color: #0d6efd;
            --bs-link-hover-color: #0a58ca;
        }

        /* Additional light theme specific overrides */
        :root[data-bs-theme='light'] .navbar,
        :root[data-bs-theme='light'] .dropdown-menu {
            border-color: var(--bs-border-color);
        }

        :root[data-bs-theme='light'] .sidebar {
            background-color: var(--bs-dark);
            border-right-color: var(--bs-border-color);
        }

        :root[data-bs-theme='light'] .top-header {
            background-color: var(--bs-dark);
            border-bottom-color: var(--bs-border-color);
        }

        :root[data-bs-theme='light'] .mobile-sidebar {
            background-color: var(--bs-dark);
            border-right-color: var(--bs-border-color);
        }

        :root[data-bs-theme='light'] .mobile-search-expanded {
            background-color: var(--bs-body-bg);
        }

        /* Ensure text contrast in light theme */
        :root[data-bs-theme='light'] .sidebar-nav .nav-link {
            color: #e9ecef;
        }

        :root[data-bs-theme='light'] .sidebar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--bs-primary);
        }

        :root[data-bs-theme='light'] .header-title,
        :root[data-bs-theme='light'] .hamburger-btn,
        :root[data-bs-theme='light'] .search-input,
        :root[data-bs-theme='light'] .search-icon-btn,
        :root[data-bs-theme='light'] .theme-toggle-btn {
            color: #e9ecef;
        }

        :root[data-bs-theme='light'] .mobile-search-input,
        :root[data-bs-theme='light'] .mobile-search-back {
            color: var(--bs-body-color);
        }

        /* Form elements in light theme */
        :root[data-bs-theme='light'] .form-control,
        :root[data-bs-theme='light'] .form-select {
            background-color: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        :root[data-bs-theme='light'] .form-control:focus,
        :root[data-bs-theme='light'] .form-select:focus {
            background-color: var(--bs-secondary-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* Button overrides for light theme */
        :root[data-bs-theme='light'] .btn-outline-primary {
            color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        :root[data-bs-theme='light'] .btn-outline-primary:hover {
            background-color: rgba(13, 110, 253, 0.1);
            border-color: var(--bs-primary);
        }

        :root[data-bs-theme='light'] .btn-outline-danger {
            color: var(--bs-danger);
            border-color: var(--bs-danger);
        }

        :root[data-bs-theme='light'] .btn-outline-danger:hover {
            background-color: rgba(220, 53, 69, 0.1);
            border-color: var(--bs-danger);
        }

        :root[data-bs-theme='light'] .btn-warning {
            background-color: var(--bs-warning);
            border-color: var(--bs-warning);
            color: #212529;
        }

        :root[data-bs-theme='light'] .btn-outline-warning {
            color: var(--bs-warning);
            border-color: var(--bs-warning);
        }

        :root[data-bs-theme='light'] .btn-outline-warning:hover {
            background-color: rgba(255, 193, 7, 0.1);
            border-color: var(--bs-warning);
        }

        /* Toast notifications in light theme */
        :root[data-bs-theme='light'] .toast {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
            color: var(--bs-body-color);
        }

        /* Dropdown menus in light theme */
        :root[data-bs-theme='light'] .dropdown-menu {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
        }

        :root[data-bs-theme='light'] .dropdown-item {
            color: var(--bs-body-color);
        }

        :root[data-bs-theme='light'] .dropdown-item:hover {
            background-color: var(--bs-primary);
            color: white;
        }

        /* List group items in light theme */
        :root[data-bs-theme='light'] .list-group-item {
            background-color: var(--bs-card-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-border-color);
        }

        /* Modal content in light theme */
        :root[data-bs-theme='light'] .modal-content,
        :root[data-bs-theme='light'] .offcanvas {
            background-color: var(--bs-card-bg);
            border-color: var(--bs-border-color);
        }
    </style>
</head>

<body class="bg-body-tertiary">
    <div id="particles-js" style="min-height: 100vh; min-width: 100vw;"></div>
    <div class="toast-container position-fixed top-0 end-0 p-3"> </div>

    <!-- Hybrid Responsive Navigation Layout -->
    <div class="app-layout">
        <!-- Desktop Persistent Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('main.index') }}" class="sidebar-brand">
                    <i class="bi bi-lightbulb"></i>
                    Sophia
                </a>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>

            {% if not current_user.is_anonymous %}
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.collections') }}" data-tooltip="My Solutions">
                            <i class="bi bi-folder2-open"></i>
                            <span>My Solutions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.notes') }}" data-tooltip="My Notes">
                            <i class="bi bi-journal-text"></i>
                            <span>My Notes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.create_snippet') }}" data-tooltip="New Snippet">
                            <i class="bi bi-plus-circle"></i>
                            <span>New Snippet</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.generate') }}" data-tooltip="AI Generate">
                            <i class="bi bi-magic"></i>
                            <span>AI Generate</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.chat') }}" data-tooltip="Chat">
                            <i class="bi bi-chat-dots"></i>
                            <span>Chat</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.intelligent_search') }}"
                            data-tooltip="Intelligent Search">
                            <i class="bi bi-search"></i>
                            <span>Intelligent Search</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false" data-tooltip="LeetCode">
                            <i class="bi bi-journal-code"></i>
                            <span>LeetCode</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('main.add_problem') }}">
                                    <i class="bi bi-plus-circle me-2"></i>Add Problem
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('main.search_solutions') }}">
                                    <i class="bi bi-search me-2"></i>Search Solutions
                                </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false" data-tooltip="{{ current_user.username }}">
                            {% if current_user.is_authenticated and current_user.avatar_filename %}
                            <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar_filename) }}?v={{ range(1,999999)|random }}"
                                class="rounded-circle me-2" width="20" height="20" alt="avatar">
                            {% else %}
                            <i class="bi bi-person-circle me-2"></i>
                            {% endif %}
                            <span>{{ current_user.username }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('main.user_profile') }}">
                                    <i class="bi bi-award me-2"></i>My Profile
                                    <span id="badge-count" class="badge bg-warning ms-2" style="display: none;">0</span>
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.edit_profile') }}">
                                    <i class="bi bi-person-gear me-2"></i>Account Settings
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.user_settings') }}">
                                    <i class="bi bi-sliders me-2"></i>User Settings
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.export_snippets') }}">
                                    <i class="bi bi-box-arrow-down me-2"></i>Export Snippets
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.help') }}">
                                    <i class="bi bi-question-circle me-2"></i>Help
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('main.logout') }}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            {% else %}
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.login') }}">
                            <i class="bi bi-box-arrow-in-right"></i>
                            Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.register') }}">
                            <i class="bi bi-person-plus"></i>
                            Register
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </nav>

        <!-- Mobile Off-Canvas Sidebar -->
        <nav class="mobile-sidebar" id="mobileSidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('main.index') }}" class="sidebar-brand">
                    <i class="bi bi-lightbulb"></i>
                    Sophia
                </a>
            </div>

            {% if not current_user.is_anonymous %}
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.collections') }}" data-tooltip="My Solutions">
                            <i class="bi bi-folder2-open"></i>
                            <span>My Solutions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.notes') }}" data-tooltip="My Notes">
                            <i class="bi bi-journal-text"></i>
                            <span>My Notes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.create_snippet') }}" data-tooltip="New Snippet">
                            <i class="bi bi-plus-circle"></i>
                            <span>New Snippet</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.generate') }}" data-tooltip="AI Generate">
                            <i class="bi bi-magic"></i>
                            <span>AI Generate</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.chat') }}" data-tooltip="Chat">
                            <i class="bi bi-chat-dots"></i>
                            <span>Chat</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.intelligent_search') }}"
                            data-tooltip="Intelligent Search">
                            <i class="bi bi-search"></i>
                            <span>Intelligent Search</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false" data-tooltip="LeetCode">
                            <i class="bi bi-journal-code"></i>
                            <span>LeetCode</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('main.add_problem') }}">
                                    <i class="bi bi-plus-circle me-2"></i>Add Problem
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('main.search_solutions') }}">
                                    <i class="bi bi-search me-2"></i>Search Solutions
                                </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false" data-tooltip="{{ current_user.username }}">
                            {% if current_user.is_authenticated and current_user.avatar_filename %}
                            <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar_filename) }}?v={{ range(1,999999)|random }}"
                                class="rounded-circle me-2" width="20" height="20" alt="avatar">
                            {% else %}
                            <i class="bi bi-person-circle me-2"></i>
                            {% endif %}
                            <span>{{ current_user.username }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('main.user_profile') }}">
                                    <i class="bi bi-award me-2"></i>My Profile
                                    <span id="mobile-badge-count" class="badge bg-warning ms-2"
                                        style="display: none;">0</span>
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.edit_profile') }}">
                                    <i class="bi bi-person-gear me-2"></i>Account Settings
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.user_settings') }}">
                                    <i class="bi bi-sliders me-2"></i>User Settings
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.export_snippets') }}">
                                    <i class="bi bi-box-arrow-down me-2"></i>Export Snippets
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.help') }}">
                                    <i class="bi bi-question-circle me-2"></i>Help
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('main.logout') }}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            {% else %}
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.login') }}">
                            <i class="bi bi-box-arrow-in-right"></i>
                            Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.register') }}">
                            <i class="bi bi-person-plus"></i>
                            Register
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </nav>

        <!-- Mobile Sidebar Overlay -->
        <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle navigation">
                            <i class="bi bi-list"></i>
                        </button>
                        <h1 class="header-title">Dev Command Center</h1>
                    </div>

                    <div class="header-right">
                        <!-- Search Container -->
                        <div class="search-container">
                            <form id="global-search-form" class="d-flex" action="{{ url_for('main.search') }}"
                                method="get">
                                <div class="search-input-wrapper">
                                    <input id="navbar-search" class="search-input" type="search" name="q"
                                        placeholder="Search snippets/solutions (supports tag:, lang:, in:, before:, after:)"
                                        aria-label="Search">
                                    <select id="search-scope" class="search-select">
                                        <option value="snippets">Snippets</option>
                                        <option value="solutions">Solutions</option>
                                        <option value="both">Both</option>
                                    </select>
                                    <button class="search-btn" type="submit">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </form>

                            <!-- Mobile Search Icon -->
                            <button class="search-icon-btn" id="searchIconBtn" aria-label="Open search">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>

                        <!-- Theme Toggle -->
                        <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle theme">
                            <i id="theme-icon" class="bi"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <div class="container-fluid px-0">
                    <div class="container-xl">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                        <div id="flash-messages" style="display: none;">
                            {% for category, message in messages %}
                            <div class="flash" data-category="{{ category }}" data-message="{{ message }}"></div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endwith %}

                        <div id="page-content">
                            {% block content %}{% endblock %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Mobile Search Expanded Overlay -->
    <div class="mobile-search-expanded" id="mobileSearchExpanded">
        <div class="mobile-search-header">
            <button class="mobile-search-back" id="mobileSearchBack">
                <i class="bi bi-arrow-left"></i>
            </button>
            <input type="text" class="mobile-search-input" id="mobileSearchInput"
                placeholder="Search snippets/solutions...">
        </div>

        <div class="mobile-search-scope">
            <button class="scope-btn active" data-scope="snippets">Snippets</button>
            <button class="scope-btn" data-scope="solutions">Solutions</button>
            <button class="scope-btn" data-scope="both">Both</button>
        </div>

        <button class="mobile-search-submit" id="mobileSearchSubmit">
            <i class="bi bi-search me-2"></i>Search
        </button>
    </div>

    <!-- Sophia Bottom-Right Widget -->
    <style>
        /* Floating Action Button (FAB) */
        #sophiaFab {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 10001;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transform-origin: bottom right;
            transition: transform .18s ease, box-shadow .18s ease, padding .2s ease, width .2s ease;
            overflow: hidden;
            white-space: nowrap;
            padding-right: 12px;
        }

        #sophiaFab .label {
            max-width: 0;
            opacity: 0;
            transition: max-width .2s ease, opacity .2s ease;
            display: inline-block;
        }

        #sophiaFab:hover {
            transform: translateZ(0) scale(1.06);
        }

        #sophiaFab:hover .label {
            max-width: 200px;
            opacity: 1;
        }

        #sophiaFab.glow {
            box-shadow: 0 0 0.9rem rgba(255, 193, 7, .95), 0 0 1.6rem rgba(255, 193, 7, .45);
        }

        /* Dock (fixed position, not draggable/resizable) */
        #sophiaDock {
            position: fixed;
            right: 16px;
            bottom: 84px;
            width: 420px;
            max-width: min(540px, calc(100% - 32px));
            height: min(520px, 70vh);
            z-index: 10000;
            display: none;
            user-select: none;
        }

        #sophiaDock.card {
            display: flex;
            flex-direction: column;
        }

        #sophiaDock .card-header {
            user-select: none;
        }

        #sophiaDock .card-body {
            flex: 1 1 auto;
            overflow: auto;
            user-select: text;
        }

        #sophiaDock .card-footer {
            user-select: none;
        }

        /* Smaller font and distinct bubbles (user only) */
        #sophiaDock .bubble {
            font-size: 0.9rem;
            border: 1px solid var(--bs-border-color);
        }

        #sophiaDock .bubble pre,
        #sophiaDock .bubble code {
            font-size: 0.85rem;
        }

        /* User bubble uses primary tint for subtle emphasis */
        #sophiaDock .msg-user .bubble {
            background-color: rgba(30, 91, 184, .15);
            border-color: rgba(30, 91, 184, .45);
        }

        /* Assistant remains neutral (no bubble) */
    </style>

    <button id="sophiaFab" type="button" class="btn btn-warning rounded-pill">
        <i class="bi bi-chat-dots fs-5"></i>
        <span class="label">Ask Sophia</span>
    </button>

    <div id="sophiaDock" class="card shadow-lg" hidden aria-hidden="true">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Sophia Assistant</strong>
            <div class="d-flex gap-2">
                <button id="sophiaClear" type="button" class="btn btn-sm btn-outline-danger">Clear</button>
                <button id="sophiaClose" type="button" class="btn btn-sm btn-outline-secondary">Close</button>
            </div>
        </div>
        <div class="card-body">
            <div id="sophia-log"></div>
        </div>
        <div class="card-footer d-flex gap-2 align-items-center">
            <input id="sophia-input" class="form-control" placeholder="Ask a question..." />
            <button id="sophia-send" class="btn btn-primary">Send</button>
            <button id="sophia-stop" class="btn btn-outline-warning">Stop</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>
    <script>moment.locale('en');</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax for inline math in chat and pages -->
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };</script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <!-- Mermaid for diagram code blocks -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>try { mermaid.initialize({ startOnLoad: false, theme: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'default' }); } catch (_) { };</script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Bottom-right widget elements
            const sophiaLog = document.getElementById('sophia-log');
            const sophiaInput = document.getElementById('sophia-input');
            const sophiaSend = document.getElementById('sophia-send');
            const sophiaStop = document.getElementById('sophia-stop');
            const sophiaDock = document.getElementById('sophiaDock');
            const sophiaFab = document.getElementById('sophiaFab');
            const sophiaClose = document.getElementById('sophiaClose');
            const sophiaClear = document.getElementById('sophiaClear');
            let inlineSessionId = null;
            let inlineAbort = null;
            let lastSelectionText = '';

            function addCopyButtons(container) {
                container.querySelectorAll('pre > code').forEach((codeEl) => {
                    const pre = codeEl.parentElement;
                    pre.style.position = 'relative';
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-secondary';
                    btn.textContent = 'Copy';
                    btn.style.position = 'absolute';
                    btn.style.top = '6px';
                    btn.style.right = '6px';
                    btn.addEventListener('click', async () => {
                        try { await navigator.clipboard.writeText(codeEl.innerText); btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); } catch (_) { }
                    });
                    pre.appendChild(btn);
                });
            }
            async function renderMermaid(container) {
                if (!window.mermaid) return;
                const blocks = container.querySelectorAll('pre > code.language-mermaid, pre > code.lang-mermaid');
                for (const code of blocks) {
                    const src = code.textContent;
                    const div = document.createElement('div');
                    div.className = 'mermaid';
                    div.textContent = src;
                    const pre = code.parentElement;
                    pre.replaceWith(div);
                }
                try { await mermaid.run({ querySelector: '.mermaid' }); } catch (_) { }
            }
            function appendChat(role, content) {
                const wrap = document.createElement('div');
                wrap.className = 'mb-3 ' + (role === 'assistant' ? 'msg-assistant' : 'msg-user');
                if (role === 'assistant') {
                    const rendered = DOMPurify.sanitize(marked.parse(content || ''));
                    wrap.innerHTML = `<div class=\"fw-bold\">Sophia</div><div class=\"p-2\">${rendered}</div>`;
                    sophiaLog.appendChild(wrap);
                    if (window.Prism) { try { Prism.highlightAllUnder(wrap); } catch (_) { } }
                    addCopyButtons(wrap);
                    if (window.MathJax && window.MathJax.typesetPromise) { try { MathJax.typesetPromise([wrap]); } catch (_) { } }
                    renderMermaid(wrap);
                } else {
                    wrap.innerHTML = `<div class=\"fw-bold\">You</div><div class=\"bubble border rounded p-2\">${DOMPurify.sanitize(content)}</div>`;
                    sophiaLog.appendChild(wrap);
                }
                sophiaLog.scrollTop = sophiaLog.scrollHeight;
            }
            async function ensureInlineSession() {
                if (inlineSessionId) return inlineSessionId;
                try {
                    const cached = localStorage.getItem('inline_chat_session_id');
                    if (cached) { inlineSessionId = Number(cached); return inlineSessionId; }
                    const res = await fetch("{{ url_for('main.api_chat_new') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: 'Quick Chat' }) });
                    const data = await res.json();
                    inlineSessionId = data.session_id;
                    localStorage.setItem('inline_chat_session_id', String(inlineSessionId));
                    return inlineSessionId;
                } catch (_) { return null; }
            }
            async function sendInline(msg) {
                appendChat('user', msg);
                // streaming container
                const wrap = document.createElement('div');
                wrap.className = 'mb-3 msg-assistant';
                wrap.innerHTML = `<div class=\"fw-bold\">Sophia</div><div class=\"p-2\"><div class=\"d-flex align-items-center gap-2 mb-2\"><div class=\"spinner-border spinner-border-sm\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div><span>Thinking...</span></div><div class=\"stream-out\"></div></div>`;
                const out = wrap.querySelector('.stream-out');
                sophiaLog.appendChild(wrap);
                sophiaLog.scrollTop = sophiaLog.scrollHeight;
                try {
                    const sid = await ensureInlineSession();
                    inlineAbort = new AbortController();
                    const res = await fetch("{{ url_for('main.api_chat_stream') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sid, message: msg }), signal: inlineAbort.signal });
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buf = '';
                    let lastRender = 0;
                    const spinner = wrap.querySelector('.spinner-border');
                    const label = wrap.querySelector('.d-flex span');
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        buf += chunk;
                        const now = performance.now();
                        if (now - lastRender > 120) {
                            if (spinner) spinner.style.display = 'none'; if (label) label.textContent = '';
                            out.innerHTML = DOMPurify.sanitize(marked.parse(buf));
                            lastRender = now;
                            sophiaLog.scrollTop = sophiaLog.scrollHeight;
                        }
                    }
                    // final render
                    out.innerHTML = DOMPurify.sanitize(marked.parse(buf));
                    if (window.Prism) { try { Prism.highlightAllUnder(wrap); } catch (_) { } }
                    addCopyButtons(wrap);
                    if (window.MathJax && window.MathJax.typesetPromise) { try { MathJax.typesetPromise([wrap]); } catch (_) { } }
                    renderMermaid(wrap);
                } catch (e) {
                    const err = document.createElement('div'); err.className = 'text-danger'; err.textContent = 'Network error'; out.replaceWith(err);
                }
            }
            if (sophiaSend) sophiaSend.addEventListener('click', () => { const v = sophiaInput.value.trim(); if (!v) return; sophiaInput.value = ''; sendInline(v); });
            if (sophiaInput) sophiaInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); const v = sophiaInput.value.trim(); if (!v) return; sophiaInput.value = ''; sendInline(v); } });
            if (sophiaStop) sophiaStop.addEventListener('click', () => { if (inlineAbort) { try { inlineAbort.abort(); } catch (_) { } } });

            async function loadInlineHistory() {
                try {
                    const sid = await ensureInlineSession();
                    if (!sid) return;
                    const res = await fetch(`{{ url_for('main.api_chat_session', session_id=0) }}`.replace('0', String(sid)));
                    const msgs = await res.json();
                    sophiaLog.innerHTML = '';
                    msgs.forEach(m => appendChat(m.role, m.content));
                } catch (_) { }
            }

            function isOpen() { return sophiaDock && !sophiaDock.hidden; }
            function openDock() { if (!sophiaDock) return; sophiaDock.hidden = false; sophiaDock.setAttribute('aria-hidden', 'false'); }
            function closeDock() { if (!sophiaDock) return; sophiaDock.hidden = true; sophiaDock.setAttribute('aria-hidden', 'true'); }
            function toggleDock() { if (!sophiaDock) return; if (isOpen()) closeDock(); else openDock(); }
            if (sophiaClose) sophiaClose.addEventListener('click', toggleDock);
            if (sophiaFab) sophiaFab.addEventListener('click', async () => {
                const opening = !isOpen();
                toggleDock();
                if (opening) {
                    await loadInlineHistory();
                }
                if (isOpen()) {
                    sophiaInput && sophiaInput.focus();
                    if (lastSelectionText && lastSelectionText.length) { const ask = lastSelectionText.slice(0, 4000); lastSelectionText = ''; sophiaFab.classList.remove('glow'); await sendInline(ask); }
                }
            });

            // Clear chat: delete current inline session and reset
            if (sophiaClear) sophiaClear.addEventListener('click', async () => {
                try {
                    const sid = await ensureInlineSession();
                    if (sid) {
                        await fetch(`{{ url_for('main.api_chat_delete', session_id=0) }}`.replace('0', String(sid)), { method: 'POST' });
                    }
                } catch (_) { }
                inlineSessionId = null;
                try { localStorage.removeItem('inline_chat_session_id'); } catch (_) { }
                if (sophiaLog) sophiaLog.innerHTML = '';
            });

            // Track current selection across the page
            function updateSelection() {
                const sel = window.getSelection();
                const text = sel ? sel.toString().trim() : '';
                if (text && text.length > 1) { lastSelectionText = text; if (sophiaFab) sophiaFab.classList.add('glow'); }
                else { lastSelectionText = ''; if (sophiaFab) sophiaFab.classList.remove('glow'); }
            }
            document.addEventListener('selectionchange', updateSelection);
            document.addEventListener('mouseup', updateSelection);

            // Expose for programmatic open
            window.openSophiaWith = async function (text) {
                openDock();
                if (text) { sophiaInput.value = text; await sendInline(text); }
            };
            const toastContainer = document.querySelector('.toast-container');

            // HYBRID NAVIGATION JAVASCRIPT
            // Collapsible Desktop Sidebar
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mainWrapper = document.querySelector('.main-wrapper');

            let autoCollapseTimeout;

            // Auto-collapse functionality
            function startAutoCollapseTimer() {
                clearTimeout(autoCollapseTimeout);
                autoCollapseTimeout = setTimeout(() => {
                    if (window.innerWidth >= 992 && !sidebar.classList.contains('collapsed')) {
                        toggleDesktopSidebar();
                    }
                }, 5000);
            }

            function resetAutoCollapseTimer() {
                startAutoCollapseTimer();
            }

            function toggleDesktopSidebar() {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');

                // Update toggle button icon
                const toggleIcon = sidebarToggle.querySelector('i');
                if (isCollapsed) {
                    toggleIcon.className = 'bi bi-chevron-right';
                } else {
                    toggleIcon.className = 'bi bi-chevron-left';
                }

                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', isCollapsed);

                // Update main wrapper margins (only margin-left, let CSS handle width)
                if (window.innerWidth >= 992) {
                    if (isCollapsed) {
                        mainWrapper.style.marginLeft = '60px';
                        // Clear auto-collapse when manually collapsed
                        clearTimeout(autoCollapseTimeout);
                    } else {
                        mainWrapper.style.marginLeft = '280px';
                        // Reset auto-collapse timer when expanded
                        startAutoCollapseTimer();
                    }
                }
            }

            function initializeSidebarState() {
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar.classList.add('collapsed');
                    const toggleIcon = sidebarToggle.querySelector('i');
                    toggleIcon.className = 'bi bi-chevron-right';

                    if (window.innerWidth >= 992) {
                        mainWrapper.style.marginLeft = '60px';
                    }
                } else {
                    // Start auto-collapse timer for desktop if not collapsed
                    if (window.innerWidth >= 992) {
                        startAutoCollapseTimer();
                    }
                }
            }

            // Handle window resize
            function handleResize() {
                if (window.innerWidth >= 992) {
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    if (isCollapsed) {
                        mainWrapper.style.marginLeft = '60px';
                        mainWrapper.style.width = 'calc(100% - 60px)';
                    } else {
                        mainWrapper.style.marginLeft = '280px';
                        mainWrapper.style.width = 'calc(100% - 280px)';
                    }
                } else {
                    mainWrapper.style.marginLeft = '0';
                    mainWrapper.style.width = '100%';
                }
            }

            // Initialize sidebar state and add event listeners
            if (sidebarToggle && sidebar) {
                initializeSidebarState();
                sidebarToggle.addEventListener('click', toggleDesktopSidebar);

                // Track user activity and reset auto-collapse timer
                sidebar.addEventListener('mouseenter', resetAutoCollapseTimer);
                sidebar.addEventListener('mousemove', resetAutoCollapseTimer);
                sidebar.addEventListener('click', resetAutoCollapseTimer);

                // Track general page activity
                document.addEventListener('mousemove', resetAutoCollapseTimer);
                document.addEventListener('keydown', resetAutoCollapseTimer);

                window.addEventListener('resize', handleResize);
            }

            // Mobile sidebar toggle
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');

            function toggleMobileSidebar() {
                mobileSidebar.classList.toggle('open');
                mobileSidebarOverlay.classList.toggle('show');
                document.body.style.overflow = mobileSidebar.classList.contains('open') ? 'hidden' : '';
            }

            function closeMobileSidebar() {
                mobileSidebar.classList.remove('open');
                mobileSidebarOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleMobileSidebar);
            }

            if (mobileSidebarOverlay) {
                mobileSidebarOverlay.addEventListener('click', closeMobileSidebar);
            }

            // Mobile search expansion
            const searchIconBtn = document.getElementById('searchIconBtn');
            const mobileSearchExpanded = document.getElementById('mobileSearchExpanded');
            const mobileSearchBack = document.getElementById('mobileSearchBack');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            const mobileSearchSubmit = document.getElementById('mobileSearchSubmit');
            const mobileSearchScopeBtns = document.querySelectorAll('.scope-btn');
            let mobileSearchScope = 'snippets';

            function openMobileSearch() {
                mobileSearchExpanded.classList.add('show');
                document.body.style.overflow = 'hidden';
                setTimeout(() => mobileSearchInput.focus(), 100);
            }

            function closeMobileSearch() {
                mobileSearchExpanded.classList.remove('show');
                document.body.style.overflow = '';
            }

            function performMobileSearch() {
                const query = mobileSearchInput.value.trim();
                if (query) {
                    let actionUrl = "{{ url_for('main.search') }}";
                    if (mobileSearchScope === 'solutions') {
                        actionUrl = "{{ url_for('main.search_solutions') }}";
                    } else if (mobileSearchScope === 'both') {
                        actionUrl = "{{ url_for('main.search_combined') }}";
                    }
                    window.location.href = `${actionUrl}?q=${encodeURIComponent(query)}`;
                }
            }

            if (searchIconBtn) {
                searchIconBtn.addEventListener('click', openMobileSearch);
            }

            if (mobileSearchBack) {
                mobileSearchBack.addEventListener('click', closeMobileSearch);
            }

            if (mobileSearchSubmit) {
                mobileSearchSubmit.addEventListener('click', performMobileSearch);
            }

            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performMobileSearch();
                    }
                });
            }

            mobileSearchScopeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    mobileSearchScopeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    mobileSearchScope = btn.dataset.scope;
                });
            });

            // Scope-aware search routing (desktop)
            const form = document.getElementById('global-search-form');
            const scopeSel = document.getElementById('search-scope');
            if (form && scopeSel) {
                form.addEventListener('submit', (e) => {
                    const scope = scopeSel.value;
                    if (scope === 'solutions') {
                        form.action = "{{ url_for('main.search_solutions') }}";
                    } else if (scope === 'both') {
                        form.action = "{{ url_for('main.search_combined') }}";
                    } else {
                        form.action = "{{ url_for('main.search') }}";
                    }
                });
            }

            // Close mobile sidebar when clicking nav links
            const mobileNavLinks = mobileSidebar.querySelectorAll('.nav-link');
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 767) {
                        closeMobileSidebar();
                    }
                });
            });

            const flashMessages = document.querySelectorAll('.flash');

            flashMessages.forEach(flash => {
                const message = flash.dataset.message;
                const category = flash.dataset.category;

                // Map flash categories to Bootstrap background colors
                const bgClass = {
                    'success': 'bg-success',
                    'danger': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[category] || 'bg-secondary';

                // Create the toast HTML
                const toastHTML = `
                    <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                // Add the toast to the container and show it
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const newToastEl = toastContainer.lastElementChild;
                const newToast = new bootstrap.Toast(newToastEl, { delay: 5000 });
                newToast.show();
            });
        });
    </script>
    <script src="https://unpkg.com/prettier@2.8.4/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-babel.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-postcss.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-markdown.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-typescript.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-yaml.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-php.js"></script>
    <script src="https://unpkg.com/prettier@2.8.4/parser-ruby.js"></script>

    <!-- State Management -->
    <script src="{{ url_for('static', filename='js/state-manager.js') }}"></script>
    <!-- Streaming AI Pipeline -->
    <script src="{{ url_for('static', filename='js/streaming-ai.js') }}"></script>

    <script>
        (() => {
            'use strict';
            const getStoredTheme = () => localStorage.getItem('theme');
            const setStoredTheme = theme => localStorage.setItem('theme', theme);
            const getPreferredTheme = () => {
                const storedTheme = getStoredTheme();
                if (storedTheme) return storedTheme;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            };
            const setTheme = theme => {
                document.documentElement.setAttribute('data-bs-theme', theme);
            };
            setTheme(getPreferredTheme());

            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');

            const updateIcon = (theme) => {
                if (themeIcon) { // Check if themeIcon exists
                    if (theme === 'dark') {
                        themeIcon.classList.remove('bi-sun-fill');
                        themeIcon.classList.add('bi-moon-stars-fill');
                    } else {
                        themeIcon.classList.remove('bi-moon-stars-fill');
                        themeIcon.classList.add('bi-sun-fill');
                    }
                }
            };
            updateIcon(getPreferredTheme());

            if (themeToggleBtn) { // Check if themeToggleBtn exists
                themeToggleBtn.addEventListener('click', () => {
                    const currentTheme = getStoredTheme() || getPreferredTheme();
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    setStoredTheme(newTheme);
                    setTheme(newTheme);
                    updateIcon(newTheme);
                });
            }
        })();
    </script>

    <script>

        // The FAB glows to indicate selection is available; clicking it asks Sophia with the selection.
    </script>

    <script>
        // Keyboard shortcuts (Shift + key to avoid browser Ctrl/Cmd conflicts)
        // Shift + S  -> focus navbar search
        // Shift + F  -> jump to filters
        // Shift + N  -> new snippet
        // Shift + J / K -> scroll between cards
        document.addEventListener('keydown', (e) => {
            if (!e.shiftKey || e.ctrlKey || e.metaKey || e.altKey) return;
            const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
            const isTyping = tag === 'input' || tag === 'textarea' || tag === 'select' || (e.target && e.target.isContentEditable);
            const key = e.key.toLowerCase();
            if (key === 's') {
                const input = document.getElementById('navbar-search');
                if (input && window.innerWidth > 767) { e.preventDefault(); input.focus(); }
                else if (window.innerWidth <= 767) { e.preventDefault(); openMobileSearch(); }
            } else if (key === 'f') {
                const el = document.getElementById('filters-bar');
                if (el) { e.preventDefault(); el.scrollIntoView({ behavior: 'smooth' }); }
            } else if (key === 'n') {
                e.preventDefault();
                window.location.href = "{{ url_for('main.create_snippet') }}";
            } else if (key === 'j' || key === 'k') {
                e.preventDefault();
                const cards = Array.from(document.querySelectorAll('.card'));
                if (!cards.length) return;
                const direction = key === 'j' ? 1 : -1;
                const currentIndex = cards.findIndex(c => c.getBoundingClientRect().top > 10);
                let target = null;
                if (direction > 0) {
                    target = cards[Math.max(currentIndex, 0)];
                } else {
                    const prevIdx = (currentIndex <= 0 ? 0 : currentIndex - 1);
                    target = cards[prevIdx];
                }
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const headers = document.querySelectorAll('h1, h2');
            headers.forEach(header => {
                const text = header.textContent;
                let newText = '';
                for (let i = 0; i < text.length; i++) {
                    newText += `<span class="char">${text[i]}</span>`;
                }
                header.innerHTML = newText;

                const chars = header.querySelectorAll('.char');
                chars.forEach((char, i) => {
                    setTimeout(() => {
                        char.style.opacity = 1;
                    }, i * 50);
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Default particlesJS configuration (full background hover animation)
        const defaultParticlesConfig = {
            "particles": {
                "number": {
                    "value": 120, // Increased number for better coverage
                    "density": {
                        "enable": true,
                        "value_area": 1000 // Increased area for better distribution
                    }
                },
                "color": {
                    "value": ["#FFFFFF", "#87CEEB", "#98FB98", "#DDA0DD", "#FFFF99"] // High contrast colors for dark background
                },
                "shape": {
                    "type": "circle", // Changed to circle for better hover effect
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 6
                    }
                },
                "opacity": {
                    "value": 0.9, // Increased opacity for better visibility
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 0.8,
                        "opacity_min": 0.6, // Increased minimum opacity
                        "sync": false
                    }
                },
                "size": {
                    "value": 5, // Increased size for better visibility
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 1,
                        "size_min": 2, // Increased minimum size
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#FFFFFF", // White lines for better visibility
                    "opacity": 0.4, // Increased line opacity
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 1.5,
                    "direction": "none", // No fixed direction for full screen movement
                    "random": true,
                    "straight": false,
                    "out_mode": "bounce", // Bounce off edges for continuous coverage
                    "bounce": true,
                    "attract": {
                        "enable": true, // Enable attraction for mouse hover
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true, // Enable mouse hover interaction
                        "mode": "attract" // Attract particles to mouse
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "repulse" // Repulse particles on click
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 200,
                        "line_linked": {
                            "opacity": 0.8
                        }
                    },
                    "bubble": {
                        "distance": 300,
                        "size": 20,
                        "duration": 2,
                        "opacity": 0.8,
                        "speed": 2
                    },
                    "repulse": {
                        "distance": 150,
                        "duration": 0.6
                    },
                    "attract": { // New attract mode for smooth mouse following
                        "distance": 200,
                        "duration": 0.4,
                        "factor": 3,
                        "speed": 2,
                        "maxSpeed": 50,
                        "easing": "ease-out-quad"
                    },
                    "push": {
                        "particles_nb": 6
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        };

        // Enhanced AI generation animation configuration with full background hover
        const aiParticlesConfig = {
            "particles": {
                "number": {
                    "value": 180, // More elements for AI effect
                    "density": {
                        "enable": true,
                        "value_area": 1000
                    }
                },
                "color": {
                    // High contrast AI colors for dark background
                    "value": ["#FFFFFF", "#87CEEB", "#98FB98", "#DDA0DD", "#FFFF99", "#FFB6C1"], // High contrast AI colors
                },
                "shape": {
                    "type": "circle",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 6
                    }
                },
                "opacity": {
                    "value": 0.95, // Very high opacity for visibility
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 1.5, // Faster animation for glow
                        "opacity_min": 0.7, // Higher minimum opacity
                        "sync": false
                    }
                },
                "size": {
                    "value": 7, // Larger size for visibility
                    "random": true,
                    "anim": {
                        "enable": true, // Enable size animation for pulsating glow
                        "speed": 8,
                        "size_min": 3, // Larger minimum size
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 120,
                    "color": "#FFFFFF", // White lines for better visibility
                    "opacity": 0.6, // Increased line opacity
                    "width": 2
                },
                "move": {
                    "enable": true,
                    "speed": 2.5, // Faster movement for AI effect
                    "direction": "none", // Full screen dynamic movement
                    "random": true,
                    "straight": false,
                    "out_mode": "bounce", // Bounce for continuous coverage
                    "bounce": true,
                    "attract": {
                        "enable": true, // Enable attraction for mouse hover
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true, // Enable mouse hover interaction
                        "mode": "attract" // Attract particles to mouse
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "bubble" // Bubble effect on click
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 250,
                        "line_linked": {
                            "opacity": 1
                        }
                    },
                    "bubble": {
                        "distance": 300,
                        "size": 25,
                        "duration": 3,
                        "opacity": 1,
                        "speed": 2
                    },
                    "repulse": {
                        "distance": 180,
                        "duration": 0.5
                    },
                    "attract": { // Enhanced attract mode for AI
                        "distance": 250,
                        "duration": 0.6,
                        "factor": 4,
                        "speed": 3,
                        "maxSpeed": 80,
                        "easing": "ease-out-cubic"
                    },
                    "push": {
                        "particles_nb": 8
                    },
                    "remove": {
                        "particles_nb": 3
                    }
                }
            },
            "retina_detect": true
        };

        // Global function to start AI animation
        window.startAiAnimation = () => {
            particlesJS('particles-js', aiParticlesConfig);
        };

        // Global function to stop AI animation
        window.stopAiAnimation = () => {
            particlesJS('particles-js', defaultParticlesConfig);
        };

        // Global function to set loading state for a button
        window.setLoadingState = (button, isLoading, loadingText = 'Loading...', spinner = true) => {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalHtml = button.innerHTML; // Store original HTML
                button.innerHTML = `
                    ${spinner ? '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' : ''}
                    ${loadingText}
                `;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalHtml || ''; // Restore original HTML
                delete button.dataset.originalHtml; // Clean up
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Check if particles.js library is loaded
            console.log('Checking particles.js library...');
            console.log('particlesJS function available:', typeof particlesJS);

            if (typeof particlesJS === 'undefined') {
                console.error('particlesJS library is not loaded!');
                return;
            }

            console.log('Initializing particles...');
            console.log('Particles container:', document.getElementById('particles-js'));

            try {
                particlesJS('particles-js', defaultParticlesConfig);
                console.log('Particles initialized successfully!');
            } catch (error) {
                console.error('Error initializing particles:', error);
                // Fallback: try with a simpler configuration
                const fallbackConfig = {
                    "particles": {
                        "number": {
                            "value": 50,
                            "density": {
                                "enable": true,
                                "value_area": 800
                            }
                        },
                        "color": {
                            "value": "#FFFFFF"
                        },
                        "shape": {
                            "type": "circle"
                        },
                        "opacity": {
                            "value": 1,
                            "random": false
                        },
                        "size": {
                            "value": 8,
                            "random": false
                        },
                        "line_linked": {
                            "enable": false
                        },
                        "move": {
                            "enable": true,
                            "speed": 1,
                            "direction": "none",
                            "random": true,
                            "straight": false,
                            "out_mode": "bounce",
                            "bounce": true
                        }
                    },
                    "interactivity": {
                        "detect_on": "canvas",
                        "events": {
                            "onhover": {
                                "enable": true,
                                "mode": "attract"
                            },
                            "onclick": {
                                "enable": true,
                                "mode": "repulse"
                            },
                            "resize": true
                        }
                    },
                    "retina_detect": true
                };
                particlesJS('particles-js', fallbackConfig);
                console.log('Fallback particles initialized!');
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pageContent = document.getElementById('page-content');

            // Fade in on page load
            pageContent.classList.add('fade-in');

            // Fade out on link click
            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', e => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('/')) {
                        e.preventDefault();
                        pageContent.classList.remove('fade-in');
                        pageContent.classList.add('fade-out');
                        setTimeout(() => {
                            window.location.href = href;
                        }, 500);
                    }
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('navbar-search');
            if (searchInput) {
                const placeholders = [
                    "Python snippets",
                    "Flask solutions",
                    "Javascript examples",
                    "CSS animations"
                ];
                let currentPlaceholder = 0;
                let currentChar = 0;
                let isDeleting = false;

                function type() {
                    const placeholder = placeholders[currentPlaceholder];
                    let displayText;

                    if (isDeleting) {
                        displayText = placeholder.substring(0, currentChar--);
                    } else {
                        displayText = placeholder.substring(0, currentChar++);
                    }

                    searchInput.setAttribute('placeholder', displayText);

                    if (!isDeleting && currentChar === placeholder.length) {
                        isDeleting = true;
                        setTimeout(type, 1500);
                    } else if (isDeleting && currentChar === 0) {
                        isDeleting = false;
                        currentPlaceholder = (currentPlaceholder + 1) % placeholders.length;
                        setTimeout(type, 300);
                    } else {
                        setTimeout(type, isDeleting ? 50 : 100);
                    }
                }
                type();
            }
        });
    </script>

    <script>
        // Load badge count for navigation
        function loadBadgeCount() {
            if (typeof current_user !== 'undefined' && current_user && !current_user.is_anonymous) {
                fetch('/api/badges')
                    .then(response => response.json())
                    .then(data => {
                        const badgeCount = data.total_count || 0;
                        const desktopBadge = document.getElementById('badge-count');
                        const mobileBadge = document.getElementById('mobile-badge-count');

                        if (badgeCount > 0) {
                            if (desktopBadge) {
                                desktopBadge.textContent = badgeCount;
                                desktopBadge.style.display = 'inline';
                            }
                            if (mobileBadge) {
                                mobileBadge.textContent = badgeCount;
                                mobileBadge.style.display = 'inline';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading badge count:', error);
                    });
            }
        }

        // Load badge count when page loads
        document.addEventListener('DOMContentLoaded', loadBadgeCount);

        // Refresh badge count when navigating between pages
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                loadBadgeCount();
            }
        });

        // Refresh badge count every 5 minutes
        setInterval(loadBadgeCount, 300000);
    </script>
</body>

</html>