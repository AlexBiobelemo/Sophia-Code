{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-brain me-2"></i>Multi-Step Thinking Results</h1>
                <a href="{{ url_for('main.generate') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-2"></i>New Generation
                </a>
            </div>
        </div>
    </div>

    {% if result %}
    <!-- Original Problem -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-question-circle me-2"></i>Original Problem</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Prompt:</h5>
                            <div class="p-3 bg-body-secondary border rounded">
                                {{ result.prompt }}
                            </div>
                        </div>
                        {% if result.test_cases %}
                        <div class="col-md-6">
                            <h5>Test Cases:</h5>
                            <div class="p-3 bg-body-secondary border rounded">
                                {{ result.test_cases }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Layer 1: Problem Decomposition & Strategy -->
    {% if result.layer1_architecture %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h3><i class="fas fa-architect me-2"></i>Layer 1: Problem Decomposition & Strategy (The Architect)
                    </h3>
                </div>
                <div class="card-body">
                    <div class="markdown-content p-3 border rounded bg-body-secondary">
                        <div id="layer1-content">{{ result.layer1_architecture }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Layer 2: Code Generation -->
    {% if result.layer2_coder %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h3><i class="fas fa-code me-2"></i>Layer 2: Code Generation (The Coder)</h3>
                </div>
                <div class="card-body">
                    <div class="markdown-content p-3 border rounded bg-body-secondary">
                        <div id="layer2-content">{{ result.layer2_coder }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Layer 3: Verification & Debugging -->
    {% if result.layer3_tester %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning">
                    <h3><i class="fas fa-vial me-2"></i>Layer 3: Verification & Debugging (The Tester)</h3>
                </div>
                <div class="card-body">
                    <div class="markdown-content p-3 border rounded bg-body-secondary">
                        <div id="layer3-content">{{ result.layer3_tester }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Layer 4: Optimization & Final Review -->
    {% if result.layer4_refiner %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h3><i class="fas fa-tachometer-alt me-2"></i>Layer 4: Optimization & Final Review (The Refiner)
                    </h3>
                </div>
                <div class="card-body">
                    <div class="markdown-content p-3 border rounded bg-body-secondary">
                        <div id="layer4-content">{{ result.layer4_refiner }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Final Code Block -->
    {% if result.final_code %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-dark">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h3><i class="fas fa-code me-2"></i>Final Optimized Code</h3>
                        <small class="text-light opacity-75">This is the executable code solution - ready to be saved as
                            a snippet</small>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="copyCode()" id="copyBtn"
                        data-bs-toggle="tooltip" title="Copy the final generated code to clipboard">
                        <i class="fas fa-copy me-1"></i>Copy Code
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Code Section:</strong> This contains only the executable code. When saving as a snippet,
                        the thinking steps will be saved separately as collapsible sections.
                    </div>
                    <div class="position-relative">
                        <pre id="finalCode" class="mb-0"><code>{{ result.final_code }}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Save as Snippet:</strong> When you save this as a snippet, the thinking steps will be
                        saved as separate collapsible fields that can be expanded to view the AI's reasoning process.
                    </div>
                    <div class="text-center">
                        {% if result.final_code %}
                        {% set description = 'Multi-Step AI Generated Solution - Problem decomposed and solved using
                        4-layer architecture: Architecture planning, code generation, testing/debugging, and
                        optimization. ' %}
                        {% set prompt_preview = result.prompt[:100] + '...' if result.prompt and result.prompt|length >
                        100 else result.prompt %}
                        {% set full_description = description + (prompt_preview if prompt_preview else 'AI-generated
                        code solution') %}
                        {% set thinking_steps = {
                        'layer1': result.layer1_architecture,
                        'layer2': result.layer2_coder,
                        'layer3': result.layer3_tester,
                        'layer4': result.layer4_refiner
                        } %}
                        <a href="{{ url_for('main.create_snippet',
                                             generated_code=result.final_code,
                                             generated_explanation=full_description,
                                             thinking_steps=thinking_steps|tojson) }}"
                            class="btn btn-success btn-lg me-3" data-bs-toggle="tooltip"
                            title="Save this AI-generated solution as a code snippet for future reference">
                            <i class="fas fa-save me-2"></i>Save as Snippet
                        </a>
                        {% endif %}
                        <button class="btn btn-outline-secondary btn-lg me-3" onclick="shareResults()"
                            data-bs-toggle="tooltip" title="Share these results with others via link or social media">
                            <i class="fas fa-share me-2"></i>Share Results
                        </button>
                        <button class="btn btn-warning btn-lg me-3" onclick="retryMultiStepGeneration()" id="retryBtn"
                            data-bs-toggle="tooltip"
                            title="Retry the multi-step generation with the same prompt and test cases">
                            <i class="fas fa-redo me-2"></i>Retry Generation
                        </button>
                        <a href="{{ url_for('main.generate') }}" class="btn btn-primary btn-lg" data-bs-toggle="tooltip"
                            title="Start a new generation with a different prompt">
                            <i class="fas fa-plus me-2"></i>Generate Another
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Info -->
    {% if result.completed_at %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Completed:</strong> {{ result.completed_at }}
                {% if result.processing_time %}
                | <strong>Processing Time:</strong> {{ result.processing_time }}
                {% endif %}
                | <strong>Status:</strong> {{ result.status|title }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Error Display -->
    {% if result.status == 'error' and result.error_message %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-triangle me-2"></i>Error Occurred</h4>
                <p>{{ result.error_message }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- No results found -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning">
                <h4><i class="fas fa-exclamation-triangle me-2"></i>No Results Found</h4>
                <p>The requested multi-step thinking results could not be found or may have expired.</p>
                <a href="{{ url_for('main.generate') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Start New Generation
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function copyCode() {
        const codeElement = document.getElementById('finalCode');
        const text = codeElement.textContent;

        navigator.clipboard.writeText(text).then(function () {
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
            btn.classList.remove('btn-outline-light');
            btn.classList.add('btn-success');

            setTimeout(function () {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-light');
            }, 2000);
        });
    }

    function shareResults() {
        if (navigator.share) {
            navigator.share({
                title: 'Multi-Step Thinking Results',
                text: 'Check out these AI-generated results using multi-step thinking!',
                url: window.location.href
            });
        } else {
            // Fallback to copying URL
            navigator.clipboard.writeText(window.location.href).then(function () {
                alert('URL copied to clipboard!');
            });
        }
    }

    function retryMultiStepGeneration() {
        const retryBtn = document.getElementById('retryBtn');
        const originalText = retryBtn.innerHTML;

        // Show loading state
        retryBtn.disabled = true;
        retryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Retrying...';

        // Get the original prompt and test cases from the page
        const promptElement = document.querySelector('#layer1-content');
        if (!promptElement) {
            alert('Could not find the original prompt. Please try generating again.');
            retryBtn.disabled = false;
            retryBtn.innerHTML = originalText;
            return;
        }

        // Extract the prompt from the first layer content
        const prompt = `{{ result.prompt }}`;
        const testCases = `{{ result.test_cases or '' }}`;

        if (!prompt) {
            alert('Could not find the original prompt. Please try generating again.');
            retryBtn.disabled = false;
            retryBtn.innerHTML = originalText;
            return;
        }

        // Call the multi-step generation API
        fetch('/generate_multi_step', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt: prompt,
                test_cases: testCases
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to the new results page
                    window.location.href = `/multi_step_results/${data.result_id}`;
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to retry generation: ' + error.message);

                // Reset button state
                retryBtn.disabled = false;
                retryBtn.innerHTML = originalText;
            });
    }

    // Render markdown content
    function renderMarkdown() {
        const markdownContents = document.querySelectorAll('.markdown-content');
        markdownContents.forEach(container => {
            const content = container.querySelector('div');
            if (content && content.textContent.trim()) {
                try {
                    // Use marked library if available (loaded in base.html)
                    if (typeof marked !== 'undefined') {
                        const rawContent = content.textContent;
                        const rendered = marked.parse(rawContent);
                        content.innerHTML = DOMPurify.sanitize(rendered);

                        // Add syntax highlighting to code blocks
                        if (typeof Prism !== 'undefined') {
                            Prism.highlightAllUnder(content);
                        }

                        // Add copy buttons to code blocks
                        addCopyButtons(content);

                        // Render MathJax if available
                        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                            MathJax.typesetPromise([content]);
                        }

                        // Render Mermaid diagrams if available
                        renderMermaid(content);
                    }
                } catch (error) {
                    console.error('Error rendering markdown:', error);
                    // Fallback to plain text
                    content.textContent = content.textContent;
                }
            }
        });
    }

    // Add copy buttons to code blocks
    function addCopyButtons(container) {
        container.querySelectorAll('pre > code').forEach((codeEl) => {
            const pre = codeEl.parentElement;
            if (pre.style.position !== 'absolute') { // Don't add if already has copy button
                pre.style.position = 'relative';
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary';
                btn.textContent = 'Copy';
                btn.style.position = 'absolute';
                btn.style.top = '6px';
                btn.style.right = '6px';
                btn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(codeEl.innerText);
                        btn.textContent = 'Copied!';
                        setTimeout(() => btn.textContent = 'Copy', 1500);
                    } catch (_) { }
                });
                pre.appendChild(btn);
            }
        });
    }

    // Render Mermaid diagrams
    function renderMermaid(container) {
        if (typeof mermaid === 'undefined') return;

        const blocks = container.querySelectorAll('pre > code.language-mermaid, pre > code.lang-mermaid');
        blocks.forEach((code) => {
            const src = code.textContent;
            const div = document.createElement('div');
            div.className = 'mermaid';
            div.textContent = src;
            const pre = code.parentElement;
            pre.replaceWith(div);
        });

        try {
            mermaid.run({ querySelector: '.mermaid' });
        } catch (_) { }
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Wait a bit for external libraries to load
        setTimeout(renderMarkdown, 100);

        // Tooltips are now handled by the custom tooltip system with 3-second delay
        // No need for Bootstrap tooltip initialization - our system handles all tooltips automatically

        // Re-render on theme change
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                setTimeout(renderMarkdown, 100);
            });
        }
    });
</script>

<style>
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        background-color: var(--bs-card-bg);
        border-color: var(--bs-border-color);
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .card-header {
        border-color: var(--bs-border-color);
    }

    .border-success {
        border-width: 2px !important;
        border-color: var(--bs-success) !important;
    }

    .border-primary {
        border-width: 2px !important;
        border-color: var(--bs-primary) !important;
    }

    .border-warning {
        border-width: 2px !important;
        border-color: var(--bs-warning) !important;
    }

    .border-info {
        border-width: 2px !important;
        border-color: var(--bs-info) !important;
    }

    .border-dark {
        border-width: 2px !important;
        border-color: var(--bs-dark) !important;
    }

    .bg-body-secondary {
        background-color: var(--bs-secondary-bg) !important;
    }

    pre {
        background-color: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 1rem;
        overflow-x: auto;
        color: var(--bs-body-color);
    }

    #finalCode {
        background-color: var(--bs-dark);
        color: var(--bs-light);
        border-radius: 0.375rem;
    }

    #finalCode code {
        color: inherit;
    }

    /* Markdown content styling */
    .markdown-content {
        line-height: 1.6;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        color: var(--bs-body-color);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .markdown-content p {
        color: var(--bs-body-color);
        margin-bottom: 1rem;
    }

    .markdown-content ul,
    .markdown-content ol {
        color: var(--bs-body-color);
        margin-bottom: 1rem;
    }

    .markdown-content li {
        color: var(--bs-body-color);
    }

    .markdown-content blockquote {
        border-left: 4px solid var(--bs-primary);
        padding-left: 1rem;
        margin: 1rem 0;
        color: var(--bs-body-color);
        background-color: var(--bs-secondary-bg);
        padding: 1rem;
        border-radius: 0.25rem;
    }

    .markdown-content code {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.9em;
    }

    .markdown-content pre {
        background-color: var(--bs-dark);
        color: var(--bs-light);
    }

    .markdown-content pre code {
        background-color: transparent;
        color: inherit;
        padding: 0;
    }

    .markdown-content table {
        color: var(--bs-body-color);
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1rem;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid var(--bs-border-color);
        padding: 0.5rem;
        text-align: left;
    }

    .markdown-content th {
        background-color: var(--bs-secondary-bg);
        font-weight: bold;
    }

    .markdown-content a {
        color: var(--bs-link-color);
    }

    .markdown-content a:hover {
        color: var(--bs-link-hover-color);
    }

    /* Dark theme specific adjustments */
    :root[data-bs-theme='dark'] .markdown-content pre {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }

    :root[data-bs-theme='dark'] .markdown-content code {
        background-color: #2a2a2a;
        color: #e0e0e0;
    }

    /* Light theme specific adjustments */
    :root[data-bs-theme='light'] .markdown-content pre {
        background-color: #f8f9fa;
        color: #495057;
    }

    :root[data-bs-theme='light'] .markdown-content code {
        background-color: #f1f3f4;
        color: #495057;
    }
</style>
{% endblock %}