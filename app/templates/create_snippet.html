{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        {% if request.args.get('generated_code') %}
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>AI Generated Content:</strong> This snippet was generated by AI. You can modify it or save it as-is.
            <div class="mt-2">
                <a href="#" class="btn btn-sm btn-outline-primary" id="retryGenerationBtn" data-bs-toggle="tooltip"
                    title="Retry AI generation with the same prompt">
                    <i class="fas fa-redo me-1"></i>Retry Generation
                </a>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">Create a New Snippet</h2>

                <script>
                    // Extract original prompt from description if available
                    function extractOriginalPrompt() {
                        const descriptionField = document.querySelector('[name="description"]');
                        if (!descriptionField || !descriptionField.value) return null;

                        const description = descriptionField.value;
                        // Look for patterns like "PROMPT: \"...\"" or similar
                        const promptMatch = description.match(/PROMPT:\s*["']([^"']+)["']/i);
                        if (promptMatch && promptMatch[1]) {
                            return promptMatch[1];
                        }

                        // Alternative pattern: look for the first substantial paragraph that might be the prompt
                        const lines = description.split('\n');
                        for (let line of lines) {
                            line = line.trim();
                            if (line.length > 20 && !line.startsWith('#') && !line.startsWith('*')) {
                                // Likely the original prompt
                                return line;
                            }
                        }

                        return null;
                    }

                    // Set up retry button functionality
                    document.addEventListener('DOMContentLoaded', function () {
                        const retryBtn = document.getElementById('retryGenerationBtn');
                        if (retryBtn) {
                            retryBtn.addEventListener('click', function (e) {
                                e.preventDefault();

                                const originalPrompt = extractOriginalPrompt();
                                let url = '{{ url_for("main.generate") }}';

                                if (originalPrompt) {
                                    // URL encode the prompt
                                    const encodedPrompt = encodeURIComponent(originalPrompt);
                                    url += `?prompt=${encodedPrompt}`;
                                }

                                window.location.href = url;
                            });
                        }

                        // Tooltips are now handled by the custom tooltip system with 3-second delay
                        // No need for Bootstrap tooltip initialization - our system handles all tooltips automatically
                    });
                </script>

                <form method="POST" action="" novalidate>
                    {{ form.hidden_tag() }}
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                            {% for error in form.title.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.language.label(class="form-label") }}
                            {{ form.language(class="form-select", id="language-select") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.collection.label(class="form-label") }}
                        {{ form.collection(class="form-select") }}
                    </div>
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows=3) }}
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            {{ form.code.label(class="form-label") }}
                            <div class="btn-group mb-1" role="group">
                                <button class="btn btn-sm btn-outline-secondary" type="button" id="format-btn"
                                    data-bs-toggle="tooltip" title="Format code with proper indentation and style"><i
                                        class="bi bi-magic me-1"></i>Format</button>
                                <button class="btn btn-sm btn-outline-secondary" type="button" id="copy-btn"
                                    title="Copy" data-bs-toggle="tooltip" title="Copy code to clipboard"><i
                                        class="bi bi-clipboard"></i></button>
                            </div>
                        </div>
                        {{ form.code(class="form-control" + (" is-invalid" if form.code.errors else ""), rows=10,
                        id="code-textarea") }}
                        {% for error in form.code.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="mb-3">
                        {{ form.tags.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.tags(class="form-control", id="tags-input") }}
                            <button class="btn btn-outline-secondary" type="button" id="suggest-tags-btn"
                                data-bs-toggle="tooltip"
                                title="Get AI-suggested tags based on your code content">Suggest
                                Tags</button>
                        </div>
                    </div>

                    <div class="border rounded p-3 mb-3 bg-body-secondary">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>AI Feedback & Refinement</strong>
                            <small class="text-muted">Paste runtime error/logs below to improve the code</small>
                        </div>
                        <textarea class="form-control mb-2" id="runtime-error-textarea" rows="4"
                            placeholder="Paste error output or failing test logs here..."></textarea>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-outline-primary" type="button" id="refine-btn"
                                data-bs-toggle="tooltip"
                                title="Refine code using AI based on error logs or runtime output">
                                Refine with Error
                            </button>
                        </div>
                        <div class="form-text">This will regenerate the code and update the description based on the
                            error.</div>
                    </div>

                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Get references to all the elements we need
    const suggestBtn = document.getElementById('suggest-tags-btn');
    const formatBtn = document.getElementById('format-btn');
    const codeTextarea = document.getElementById('code-textarea');
    const tagsInput = document.getElementById('tags-input');
    const langSelect = document.getElementById('language-select');
    const refineBtn = document.getElementById('refine-btn');
    const runtimeErrorTextarea = document.getElementById('runtime-error-textarea');

    // --- Suggest Tags Logic ---
    suggestBtn.addEventListener('click', async () => {
        const code = codeTextarea.value;
        if (!code) {
            alert('Please enter some code before suggesting tags.');
            return;
        }
        suggestBtn.disabled = true;
        suggestBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Suggesting...';
        try {
            const response = await fetch("{{ url_for('main.suggest_tags') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });
            const data = await response.json();
            if (data.tags) {
                tagsInput.value = data.tags;
            }
        } catch (error) {
            console.error('Error fetching tags:', error);
            alert('Could not fetch tag suggestions.');
        } finally {
            suggestBtn.disabled = false;
            suggestBtn.innerHTML = 'Suggest Tags';
        }
    });

    // --- Refine with Error Logic ---
    refineBtn.addEventListener('click', async () => {
        const code = codeTextarea.value.trim();
        const errorText = runtimeErrorTextarea.value.trim();
        const language = langSelect.value;
        if (!code) { alert('Please ensure code is present.'); return; }
        if (!errorText) { alert('Please paste the runtime error/output.'); return; }
        refineBtn.disabled = true;
        const original = refineBtn.innerHTML;
        refineBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Refining...';
        try {
            const res = await fetch("{{ url_for('main.refine') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code, error: errorText, language: language })
            });
            const data = await res.json();
            if (data.error) {
                alert(data.error);
            } else if (data.code) {
                codeTextarea.value = data.code;
                const desc = document.querySelector('[name="description"]');
                if (desc) {
                    const newExpl = (data.explanation || '').trim();
                    const hdr = '\n\n---\n\n### Updated AI Explanation\n';
                    desc.value = (desc.value || '').trim() + (newExpl ? hdr + newExpl : '');
                }
                // Clear the error box after successful refinement
                runtimeErrorTextarea.value = '';
            }
        } catch (e) {
            console.error('Refine error', e);
            alert('Failed to refine code. Please try again.');
        } finally {
            refineBtn.disabled = false;
            refineBtn.innerHTML = original;
        }
    });

    // --- Copy Code ---
    const copyBtn = document.getElementById('copy-btn');
    copyBtn.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(codeTextarea.value || '');
            copyBtn.innerHTML = '<i class="bi bi-clipboard-check"></i>'; setTimeout(() => copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>', 1200);
        } catch (_) { }
    });

    // --- Format Code Logic ---
    formatBtn.addEventListener('click', () => {
        const lang = langSelect.value;
        const code = codeTextarea.value;
        let parser;

        switch (lang) {
            case 'javascript': parser = 'babel'; break;
            case 'typescript': parser = 'typescript'; break;
            case 'html': parser = 'html'; break;
            case 'css': parser = 'css'; break;
            case 'markdown': parser = 'markdown'; break;
            case 'yaml': parser = 'yaml'; break;
            case 'php': parser = 'php'; break;
            case 'ruby': parser = 'ruby'; break;
            default:
                alert('Formatting for "' + lang + '" is not supported.');
                return;
        }

        try {
            const formattedCode = prettier.format(code, {
                parser: parser,
                plugins: prettierPlugins,
            });
            codeTextarea.value = formattedCode;
        } catch (error) {
            alert('Could not format code. Please check for syntax errors.');
            console.error(error);
        }
    });

    // Draft autosave for create form
    (() => {
        const KEY = 'draft_create_snippet';
        const form = document.querySelector('form');
        if (!form) return;
        // restore
        try {
            const raw = localStorage.getItem(KEY);
            if (raw) {
                const d = JSON.parse(raw);
                if (d.title) form.querySelector('[name="title"]').value = d.title;
                if (d.language) form.querySelector('[name="language"]').value = d.language;
                if (d.description) form.querySelector('[name="description"]').value = d.description;
                if (d.code) form.querySelector('[name="code"]').value = d.code;
                if (d.tags) form.querySelector('[name="tags"]').value = d.tags;
                if (d.collection) form.querySelector('[name="collection"]').value = d.collection;
            }
        } catch (_) { }
        const save = () => {
            const d = {
                title: form.querySelector('[name="title"]').value,
                language: form.querySelector('[name="language"]').value,
                description: form.querySelector('[name="description"]').value,
                code: form.querySelector('[name="code"]').value,
                tags: form.querySelector('[name="tags"]').value,
                collection: form.querySelector('[name="collection"]').value,
            };
            try { localStorage.setItem(KEY, JSON.stringify(d)); } catch (_) { }
        };
        form.addEventListener('input', save);
        form.addEventListener('submit', () => { try { localStorage.removeItem(KEY); } catch (_) { } });
    })();
</script>
{% endblock %}